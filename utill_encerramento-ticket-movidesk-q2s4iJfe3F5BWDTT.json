{"updatedAt":"2025-12-17T13:49:52.000Z","createdAt":"2025-12-17T13:46:57.591Z","id":"q2s4iJfe3F5BWDTT","name":"Utill_encerramento ticket movidesk","active":false,"isArchived":true,"nodes":[{"parameters":{"jsCode":"const htmlCliente = $input.first().json.htmlCliente\n\nreturn {\n  json: {\n    actions: [\n      { type: 2, description: htmlCliente, createdBy: { id: \"1458772347\" }}\n    ]\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[112,96],"id":"6eb6350e-1e11-483f-bcee-45b99b362098","name":"JSON para notificação1"},{"parameters":{"jsCode":"// ==== RETORNA GREETING CONFORME TURNO ====\nfunction getGreeting() {\n\tconst horaInicioNoite = 18;\n\tconst horaFinalNoite = 5;\n\tconst horaInicialDia = 5;\n\tconst horaFinalDia = 12;\n\n\t// CORREÇÃO: obter hora corretamente no fuso São Paulo\n\tconst horaLocal = DateTime.now().setZone(\"America/Sao_Paulo\").hour;\n\n\tlet greeting;\n\n\tif (horaLocal >= horaInicioNoite || horaLocal < horaFinalNoite) {\n\t\tgreeting = \"Boa noite\";\n\t} else if (horaLocal >= horaInicialDia && horaLocal < horaFinalDia) {\n\t\tgreeting = \"Bom dia\";\n\t} else {\n\t\tgreeting = \"Boa tarde\";\n\t}\n\n\treturn greeting;\n}\n\nconst flag_eventos_relacionados = $(\"Flag eventos relacionados\").first().json.flagEventosRelacionados;\n\n// valida 1 único evento\nif (flag_eventos_relacionados == false) {\n  const host = $('Ajusta dados do evento').first().json.nome_host;\n  const evento = $('Ajusta dados do evento').first().json.nome_trigger;\n  const queda = $('Ajusta dados do evento').first().json.data_hora_evento;\n  const restabelecimento = $('Ajusta dados do evento').first().json.data_hora_recuperacao;\n  let linhaTabela = \"\";\n  linhaTabela += `\n    <tr>\n      <td>${host}</td>\n      <td>${evento}</td>\n      <td>${queda}</td>\n      <td>${restabelecimento}</td>\n  \n    </td>\n  `;\n  // ==== CLIAR HTML DO CLIENTE ====\n  function htmlCliente (linhasTabelasFormatadas){\n    const htmlCliente = `\n      <p>${getGreeting()}</p>\n  \n      <p>\n        Informamos que o evento abaixo foi <strong>normalizado</strong> em nosso sistema de monitoramento.\n      </p>\n  \n      <div style=\"width: 95%; padding: 10px; margin: 10px 0; text-align: center;\">\n        <table border=\"1\" cellspacing=\"0\" cellpadding=\"5\" style=\"width: 100%; border-collapse: collapse;\">\n          <thead>\n            <tr>\n              <th>Host</th>\n              <th>Evento</th>\n              <th>Horário da ocorrência</th>\n              <th>Horário da normalização</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${linhasTabelasFormatadas}\n          </tbody>\n        </table>\n      </div>\n  \n      <p>\n        Permanecemos à disposição para quaisquer esclarecimentos adicionais.\n      </p>\n  \n      <p>\n        Atenciosamente,<br>\n      </p>\n  \n      <img \n        src=\"https://s3.amazonaws.com/movidesk-files/F63A932F58073D98A6D18347DEE480C5?AWSAccessKeyId=AKIAWSRCTWGBHCVKCQGD&Expires=1762462132&Signature=q%2FTkmFvX5ZyV4Id96xCPLnHgNzs%3D\"\n        alt=\"Assinatura\"\n      >\n    `;\n    return htmlCliente;\n  }\n  return [{\n    htmlCliente: htmlCliente(linhaTabela)\n  }];\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-112,96],"id":"51505211-5dea-40cc-964d-ea57d2f8247e","name":"HTML para notificação1"},{"parameters":{"method":"PATCH","url":"https://atendimento.maxprotection.com.br/public/v1/tickets","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"id","value":"={{ $('Separa o eventos com ticket movidesk').item.json.ticket_movidesk }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[336,96],"id":"b5cf1c8b-3da8-4a3c-af90-ff3971fb00cf","name":"Movidesk: Notifica1","alwaysOutputData":true,"credentials":{"httpQueryAuth":{"id":"TMwtQv0hjXbvLVng","name":"Movidesk token"}}},{"parameters":{"jsCode":"return {\n  json: {\n    status: \"Resolvido\",\n    baseStatus: \"Closed\", //\"Stopped\"\n    justification: null, //\"Validação\"\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[560,96],"id":"56487b68-4fb0-4db1-81e4-ed0ed021dcae","name":"JSON para encerramento1"},{"parameters":{"method":"PATCH","url":"https://atendimento.maxprotection.com.br/public/v1/tickets","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"id","value":"={{ $('Separa o eventos com ticket movidesk').item.json.ticket_movidesk }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[784,96],"id":"125ec07d-9596-4f2b-ad8e-81e9b9ec104f","name":"Movidesk: Encerra1","credentials":{"httpQueryAuth":{"id":"TMwtQv0hjXbvLVng","name":"Movidesk token"}}},{"parameters":{"authentication":"webhook","content":"=","options":{},"embeds":{"values":[{"description":"=**CLIENTE:** {{ $('Ajusta dados do evento').first().json.raiz_nome_host }}\n- **HOST:** {{ $('Ajusta dados do evento').first().json.nome_host }}\n- **EVENTO:** {{ $('Ajusta dados do evento').first().json.nome_trigger }}\n- **INDISPONÍVEL EM:** {{ $('Ajusta dados do evento').first().json.data_hora_evento }}\n- **RECUPERADO EM:** {{ $('Ajusta dados do evento').first().json.data_hora_recuperacao }}\n- **TICKET MOVIDESK:** {{ $('Separa o eventos com ticket movidesk').first().json.ticket_movidesk }}","author":"Fluxo de entrada","color":"#69BF6C","title":"=Evento encerrado","thumbnail":"https://cdn-icons-png.freepik.com/64/16799/16799619.png"}]}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[1008,96],"id":"9e9efbea-0424-4610-8752-1d9337387d9e","name":"Contratos: encerramento sla excedido","webhookId":"5602e92a-bce3-4895-9977-2ff14b2bfc30","retryOnFail":true,"credentials":{"discordWebhookApi":{"id":"Bk2P3MvXnNNWNRrD","name":"Contratos: Encerramento de alertas"}}}],"connections":{"JSON para notificação1":{"main":[[{"node":"Movidesk: Notifica1","type":"main","index":0}]]},"HTML para notificação1":{"main":[[{"node":"JSON para notificação1","type":"main","index":0}]]},"Movidesk: Notifica1":{"main":[[{"node":"JSON para encerramento1","type":"main","index":0}]]},"JSON para encerramento1":{"main":[[{"node":"Movidesk: Encerra1","type":"main","index":0}]]},"Movidesk: Encerra1":{"main":[[{"node":"Contratos: encerramento sla excedido","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"f7495c04-c22b-4b36-bcfd-376cd3474afa","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-17T13:46:57.635Z","createdAt":"2025-12-17T13:46:57.635Z","role":"workflow:owner","workflowId":"q2s4iJfe3F5BWDTT","projectId":"UcF1WBdewsFeRVFr"}],"activeVersion":null,"tags":[]}