{"updatedAt":"2025-12-02T20:00:59.000Z","createdAt":"2025-11-28T01:15:17.042Z","id":"ZVeD95d6p3HW0csG","name":"02. encerramento de chamados","active":true,"isArchived":true,"nodes":[{"parameters":{"jsCode":"const eventosRelacionados = $input.first().json.eventsRelacionados\n\nlet rotaEventosRelacionados = null;\nif (eventosRelacionados.length >= 2) {\n  rotaEventosRelacionados = true;\n} else {\n  rotaEventosRelacionados = false;\n}\n\n\nreturn [\n  {\n    eventosRelacionados,\n    rotaEventosRelacionados\n  }\n]"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3424,752],"id":"63838c2c-9ad5-46e0-abd9-7bc4df7e5b83","name":"Prepara os dados para vários eventos","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2df73fb5-8791-48c0-88fb-d345f41813ef","leftValue":"={{ $json.rotaEventosRelacionados }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3648,752],"id":"bffbc3a7-8df7-494c-9a40-5af420a03d1c","name":"Existem dois eventos ou mais?","disabled":true},{"parameters":{"jsCode":"const resultadoConsultaClock = $input.first().json.result;\nconst arrayHosts = $('Organiza os dados em arrays').first().json.hosts;\nconst arrayEventos = $('Organiza os dados em arrays').first().json.eventos;\n\nconst arrayClocks = [];\nfor (const consultaClock of resultadoConsultaClock) {\n  arrayClocks.push(consultaClock.clock);\n}\n\n// ==== RETORNA GREETING CONFORME HORÁRIO ATUAL EM SÃO PAULO ====\nfunction getGreeting() {\n  const horaSaoPaulo = new Date().toLocaleString(\"en-US\", { timeZone: \"America/Sao_Paulo\" });\n  const hora = new Date(horaSaoPaulo).getHours();\n\n  if (hora >= 18 || hora < 5) return \"Boa noite\";\n  if (hora >= 5 && hora < 12) return \"Bom dia\";\n  return \"Boa tarde\";\n}\nconst greeting = getGreeting();\n\n// ==== CONVERTE TIMESTAMP PARA FORMATO BR ====\nfunction formatarData(timestamp) {\n  const dateFormatada = DateTime.fromSeconds(Number(timestamp)).setZone('America/Sao_Paulo').toFormat('dd/MM/yyyy - HH:mm:ss');\n\n  return dateFormatada\n}\n\n// ==== MONTAGEM DA LINHA DA TABELA ====\nfunction montaLinhaTabela(arrayHosts, arrayEventos, arrayClocks) {\n  let linhasTabela = \"\";\n\n  for (let i = 0; i < arrayHosts.length; i++) {\n    const host = arrayHosts[i] || \"-\";\n    const evento = arrayEventos[i] || \"-\";\n    const dataHora = arrayClocks[i] ? formatarData(arrayClocks[i]) : \"-\";\n    \n    linhasTabela += `\n      <tr>\n        <td>${host}</td>\n        <td>${evento}</td>\n        <td>${dataHora}</td>\n      </tr>\n    `;\n  }\n\n  return linhasTabela;\n}\n\n\n\n// ===== PREPARAÇÃO PARA NOTIFICAÇÃO DE ENCERRAMENTO DE CHAMADO ====\nconst htmlCliente = `\n  <p>${greeting}</p>\n  <br>\n  <p>O seguinte alerta consta como restabelecido em nosso sistema de monitoramento:</p>\n  \n  <div style=\"width: 90%; padding: 10px; margin:10px 0; text-align: center; align-items: center;\">\n    <table border=\"1\" cellspacing=\"0\" cellpadding=\"5\" style=\"width:100%\">\n      <thead>\n          <tr>\n            <th>Hosts</th>\n            <th>Eventos</th>\n            <th>Horário das quedas</th>\n            <th>Horário do restabelecimento</th>\n          </tr>\n      </thead>\n      <tbody>\n          ${montaLinhaTabela(arrayHosts, arrayEventos, arrayClocks)}\n      </tbody>\n    </table>\n  </div>\n  <p>Permanecemos à disposição</p>\n  <br>\n  \n  <p>Atenciosamente,</p>\n  <img src=\"https://s3.amazonaws.com/movidesk-files/F63A932F58073D98A6D18347DEE480C5?AWSAccessKeyId=AKIAWSRCTWGBHCVKCQGD&Expires=1762462132&Signature=q%2FTkmFvX5ZyV4Id96xCPLnHgNzs%3D\">\n`;\n\n// ==== RETORNO FINAL ====\nreturn {\n  json: {\n    actions: [\n      {\n        type: 2,\n        description: htmlCliente,\n        createdBy: { id: \"1458772347\" },\n        workTime: \"00:02:00\"\n      }\n    ]\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4768,752],"id":"4b824536-be28-4959-bb50-899430f154ea","name":"Ajusta informação de encerramento para n eventos","disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"event.get\",\n  \"params\": {\n    \"output\": [\"eventid\", \"name\", \"r_eventid\"],\n    \"eventids\": [{{ $json.eventosRelacionados }}],\n\n    \"selectHosts\": [\"hostid\", \"name\", \"description\"],\n\n    \"selectRelatedObject\": [\n      \"description\",\n      \"value\"\n    ]\n  },\n  \"auth\": \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  \"id\": 1\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3872,656],"id":"d62ece49-174e-4344-98c0-69fdf14ebab3","name":"Zabbix: Consulta dados de n eventos","retryOnFail":true,"disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"event.get\",\n  \"params\": {\n    \"output\": [\"eventid\", \"clock\"],\n    \"eventids\": [{{$json.rEventRecuperacao}}],\n    \"selectHosts\": [\"name\"]\n  },\n  \"auth\": \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  \"id\": 1\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4544,752],"id":"005482a4-04cd-4dfc-a8d5-01fa07a59dea","name":"Zabbix: Recupera o clock dos eventos","retryOnFail":true,"disabled":true},{"parameters":{"method":"PATCH","url":"=https://atendimento.maxprotection.com.br/public/v1/tickets?token=538206c9-60b4-4bf4-ae85-415ab9a68be6&id={{ $('Supabase: Recupera correspondências1').item.json.ticket_movidesk }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4992,848],"id":"3e0f6f22-673b-4912-ba6a-7ffbabbe2982","name":"Movidesk: Notifica encerramento","retryOnFail":true,"disabled":true},{"parameters":{"method":"PATCH","url":"=https://atendimento.maxprotection.com.br/public/v1/tickets?token=538206c9-60b4-4bf4-ae85-415ab9a68be6&id={{ $('Supabase: Recupera correspondências1').item.json.ticket_movidesk }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5664,848],"id":"3f0efa96-2e12-46dd-875b-ec93fb56d4ad","name":"Movidesk: Encerra ticket no Movidesk","retryOnFail":true,"disabled":true},{"parameters":{"operation":"update","tableId":"base","matchType":"allFilters","filters":{"conditions":[{"keyName":"id_evento","condition":"eq","keyValue":"={{ $('Quando executado o main').item.json[\"id do evento\"] }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"id_evento_recuperacao","fieldValue":"={{ $('Normaliza os dados').item.json['timestamp da recuperação'] }}"},{"fieldId":"status_chamado","fieldValue":"5"},{"fieldId":"timestampRecuperacao","fieldValue":"={{ $('Normaliza os dados').item.json['timestamp da recuperação'] }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3200,752],"id":"827d4489-d7ef-439b-afd2-a70c4b24ef80","name":"Supabase: Atualiza timestamp de recuperação","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}}},{"parameters":{"jsCode":"const nomeHost = $('Normaliza os dados').first().json['nome completo do host'];\nconst nomeEvento = $('Normaliza os dados').first().json['evento gerador'];\nconst dataHoraQueda_formatada = $('Normaliza os dados').first().json['data e hora da queda']\nconst dataHoraRestabelecimento_formatada = $('Normaliza os dados').first().json['data e hora da recuperação'];\n\n\n// ==== RETORNA GREETING CONFORME HORÁRIO ATUAL EM SÃO PAULO ====\nfunction getGreeting() {\n  // Obtém o horário atual diretamente no fuso horário de São Paulo\n  const agora = new Date().toLocaleString(\"pt-BR\", { timeZone: \"America/Sao_Paulo\" });\n  const horaAtual = new Date(agora).getHours();\n\n  if (horaAtual >= 18 || horaAtual < 5) {\n    return \"Boa noite\";\n  } else if (horaAtual >= 5 && horaAtual < 12) {\n    return \"Bom dia\";\n  } else {\n    return \"Boa tarde\";\n  }\n};\nconst greeting = getGreeting();\n\n\n// ==== MONTAGEM DA LINHA DA TABELA ====\nfunction montaLinhaTabela(host, evento, quedaFormatada, restabelecimentoFormatado) {\n  let linhasTabela = `\n    <td>${host}</td>\n    <td>${evento}</td>\n    <td>${quedaFormatada}</td>\n    <td>${restabelecimentoFormatado}</td>\n  `;\n\n  return linhasTabela;\n};\n\n\n// ===== PREPARAÇÃO PARA NOTIFICAÇÃO DE ENCERRAMENTO DE CHAMADO ====\nconst htmlCliente = `\n  <p>${greeting}</p>\n  <br>\n  <p>O seguinte alerta consta como restabelecido em nosso sistema de monitoramento:</p>\n  \n  <div style=\"width: 90%; padding: 10px; margin:10px 0; text-align: center; align-items: center;\">\n    <table border=\"1\" cellspacing=\"0\" cellpadding=\"5\" style=\"width:100%\">\n      <thead>\n          <tr>\n            <th>Hosts</th>\n            <th>Eventos</th>\n            <th>Horário das quedas</th>\n            <th>Horário do restabelecimento</th>\n          </tr>\n      </thead>\n      <tbody>\n          ${montaLinhaTabela(nomeHost, nomeEvento, dataHoraQueda_formatada, dataHoraRestabelecimento_formatada)}\n      </tbody>\n    </table>\n  </div>\n  <p>Permanecemos à disposição</p>\n  <br>\n  \n  <p>Atenciosamente,</p>\n  <img src=\"https://s3.amazonaws.com/movidesk-files/F63A932F58073D98A6D18347DEE480C5?AWSAccessKeyId=AKIAWSRCTWGBHCVKCQGD&Expires=1762462132&Signature=q%2FTkmFvX5ZyV4Id96xCPLnHgNzs%3D\">\n`;\n\n// ==== RETORNO QUE SERÁ USADO PELO HTTPREQUEST NO PRÓXIMO NÓ ====\nreturn {\n  json: {\n    actions: [\n      {\n        type: 2,\n        description: htmlCliente,\n        createdBy: { id: \"1458772347\" },\n        workTime: \"00:02:00\"\n      }\n    ]\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4768,944],"id":"9ebef0f7-284e-43e5-a6e6-ffb2c3c05cff","name":"Supabase: Atualiza encerramento do evento","disabled":true},{"parameters":{"amount":1.5},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[5216,848],"id":"ea335427-d70e-46de-b4a7-83a78d0fbb88","name":"Aguarda","webhookId":"3412b67e-a067-45e3-8c98-ea268685dee3","disabled":true},{"parameters":{"jsCode":"return {\n  json: {\n    status: \"Resolvido\",\n    baseStatus: \"Closed\", //\"Stopped\"\n    justification: null, //\"Validação\"\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5440,848],"id":"91db6554-a29a-46a3-88bf-f989c0aeef63","name":"Prepara dados para encerramento ","disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"event.get\",\n  \"params\": {\n    \"output\": [\"eventid\", \"clock\", \"name\"],\n    \"eventids\": \"{{ $json.rEventRecuperacao[0] }}\",\n\n    \"selectHosts\": [\"hostid\", \"name\", \"description\"],\n\n    \"select_acknowledges\": [\n      \"acknowledgeid\",\n      \"eventid\",\n      \"clock\",\n      \"message\",\n      \"action\"\n    ],\n\n    \"selectRelatedObject\": [\n      \"triggerid\",\n      \"description\",\n      \"value\",\n      \"priority\"\n    ]\n  },\n  \"auth\": \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  \"id\": 1\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4768,560],"id":"95211466-8872-4cbd-bea5-86c6d93b5be6","name":"Consulta dados do evento no Zabbix","retryOnFail":true,"disabled":true},{"parameters":{"method":"POST","url":"=https://atendimento.maxprotection.com.br/public/v1/tickets?token=538206c9-60b4-4bf4-ae85-415ab9a68be6","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5888,560],"id":"3b8e1545-c4e0-4639-9aaf-8f52658f790d","name":"Movidesk: Notifica indisponibilidade1","retryOnFail":true,"disabled":true},{"parameters":{"jsCode":"const nomeHost = $('Ajusta as informações do evento').first().json.nomeHostCompleto;\nconst nomeEvento = $('Ajusta as informações do evento').first().json.nomeEvento;\nconst dataHoraFormatada = $('Ajusta as informações do evento').first().json.dataHoraQuedaFormatado;\nconst idMovideskAberturaTickets = $('Normaliza os dados').first().json['id de abertura de chamado no movidesk'];\nlet copiaTicketMovidesk = $('Normaliza os dados').first().json['e-mail em cópia'];\nconst ticketMovideskAnterior = $('Supabase: Recupera correspondências1').first().json.ticket_movidesk;\n\nif (copiaTicketMovidesk == \"\") {\n  copiaTicketMovidesk = \"\"\n} else {\n  copiaTicketMovidesk\n};\n\n// ==== RETORNA GREETING CONFORME HORÁRIO ATUAL EM SÃO PAULO ====\nfunction getGreeting() {\n  const horaSaoPaulo = new Date().toLocaleString(\"en-US\", { timeZone: \"America/Sao_Paulo\" });\n  const hora = new Date(horaSaoPaulo).getHours();\n\n  if (hora >= 18 || hora < 5) return \"Boa noite\";\n  if (hora >= 5 && hora < 12) return \"Bom dia\";\n  return \"Boa tarde\";\n}\nconst greeting = getGreeting();\n\n// ==== MONTAGEM DA LINHA DA TABELA ====\nfunction montaLinhaTabela(host, evento, quedaEm) {\n  let linhasTabela = `\n    <tr>\n      <td>${host}</td>\n      <td>${evento}</td>\n      <td>${quedaEm}</td>\n    </tr>\n  `;\n  \n  return linhasTabela;\n}\n\n\n\n// ==== VARIÁVEIS DO CLIENTE =====\nconst idCliente = idMovideskAberturaTickets // para teste: \"1836303904\";\nconst emCopiaPara = copiaTicketMovidesk;\n\n\n// ===== PREPARAÇÃO PARA NOTIFICAÇÃO DE ENCERRAMENTO DE CHAMADO ====\nconst htmlCliente = `\n  <p>${greeting}</p>\n  <br>\n  <p>O alerta associado ao ticket ${ticketMovideskAnterior} já havia sido reportado. No momento, ele continua indisponível, enquanto os demais alertas já foram normalizados e notificados.</p>\n  \n  <div style=\"width: 90%; padding: 10px; margin:10px 0; text-align: center; align-items: center;\">\n    <table border=\"1\" cellspacing=\"0\" cellpadding=\"5\" style=\"width:100%\">\n      <thead>\n          <tr>\n            <th>Hosts</th>\n            <th>Eventos</th>\n            <th>Horário das quedas</th>\n          </tr>\n      </thead>\n      <tbody>\n          ${montaLinhaTabela(nomeHost, nomeEvento, dataHoraFormatada)}\n      </tbody>\n    </table>\n  </div>\n  <p>Permanecemos à disposição</p>\n  <br>\n  \n  <p>Atenciosamente,</p>\n  <img src=\"https://s3.amazonaws.com/movidesk-files/F63A932F58073D98A6D18347DEE480C5?AWSAccessKeyId=AKIAWSRCTWGBHCVKCQGD&Expires=1762462132&Signature=q%2FTkmFvX5ZyV4Id96xCPLnHgNzs%3D\">\n`;\n\n\n// ==== RETORNO QUE SERÁ USADO PELO HTTPREQUEST NO PRÓXIMO NÓ ====\nreturn {\n  json: {\n    type: 2,\n    subject: `REPARO - ${nomeHost}`,\n    category: \"01 - Atendimento Helpdesk\",\n    serviceFirstLevelId: 325878,\n    urgency: \"Média\",\n    ownerTeam: \"NOC\",\n    status: \"Aguardando\",\n    justification: \"Validação\",\n    createdBy: { id: \"1458772347\" },\n    Clients: [{ id: idCliente }],\n    cc: emCopiaPara,\n    actions: [\n      { type: 2, description: htmlCliente, createdBy: { id: \"1458772347\" } }\n    ]\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5664,560],"id":"dd521508-c73b-4e20-bb18-ffd0356dab4f","name":"Prepara dados para abertura de chamado1","disabled":true},{"parameters":{"authentication":"webhook","content":"=","options":{},"embeds":{"values":[{"description":"=O seguinte alerta foi encerrado e o cliente notificado\n\n**HOST:** {{ $('Normaliza os dados').item.json['nome completo do host'] }}\n**EVENTO:** {{ $('Normaliza os dados').item.json['evento gerador'] }}\n**DATA E HORA DA QUEDA:** {{ $('Normaliza os dados').item.json['data e hora da queda'] }}\n**DATA E HORA DO RESTABELECIMENTO:** {{ $('Normaliza os dados').item.json['data e hora da recuperação'] }}\n\n**TICKET MOVIDESK:** {{ $('Supabase: Recupera correspondências1').item.json.ticket_movidesk }}","color":"#69BF6C","title":"TICKET ENCERRADO!","thumbnail":"https://imagepng.org/wp-content/uploads/2019/12/check-icone-scaled.png"}]}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[5888,848],"id":"a7215dbe-8a59-4041-aaef-ec66c40bc133","name":"Notifica encerramento","webhookId":"5602e92a-bce3-4895-9977-2ff14b2bfc30","retryOnFail":true,"credentials":{"discordWebhookApi":{"id":"lA2qaXo0Uc6Pobsl","name":"Canal: encerramento de chamado"}},"disabled":true},{"parameters":{"jsCode":"const resultados = $input.first().json.result;\n\nlet hosts = [];\nlet eventos = [];\nlet rEventRecuperacao = [];\nlet eventosAtivos = [];\n\nfor (const resultado of resultados) {\n  if (parseInt(resultado.r_eventid) >= 1 && parseInt(resultado.relatedObject.value) == 0) {\n    hosts.push(resultado.hosts[0].name);\n    eventos.push(resultado.name);\n    rEventRecuperacao.push(resultado.r_eventid);\n  } else if (parseInt(resultado.r_eventid) == 0 && parseInt(resultado.relatedObject.value) == 1) {\n    eventosAtivos.push(resultado.eventid)\n  }\n}\n\nreturn [\n  {\n    hosts,\n    eventos,\n    rEventRecuperacao,\n    eventosAtivos\n  }\n]"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4096,656],"id":"7333c62e-5d07-4e16-8ebe-18d612f49bb1","name":"Organiza os dados em arrays","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"881a983b-8175-4fde-9f88-29171f05d83c","leftValue":"={{ $json.eventosAtivos }}","rightValue":1,"operator":{"type":"array","operation":"lengthGte","rightType":"number"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[4320,656],"id":"8a24e4aa-139e-4829-a5e2-1354dc3633b5","name":"If","disabled":true},{"parameters":{"jsCode":"// --- Entrada / extração ---\nconst nomeHostCompleto = $input.first().json.result[0].hosts[0].name;\nconst nomeEvento = $input.first().json.result[0].relatedObject.description;\nconst idHost = parseInt($input.first().json.result[0].hosts[0].hostid) || null;\nconst timestampQueda = parseInt($input.first().json.result[0].clock) || null;\nconst idEvento = parseInt($input.first().json.result[0].eventid);\n\n// --- Formata data (dd/MM/yyyy HH:mm:ss) com timezone São Paulo ---\nfunction formatarTimestamp(ts) {\n  if (!ts) return null;\n  return new Intl.DateTimeFormat(\"pt-BR\", {\n    timeZone: \"America/Sao_Paulo\",\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: false\n  }).format(new Date(ts * 1000));\n}\nconst dataHoraQuedaFormatado = formatarTimestamp(timestampQueda);\n\n// --- Nome limpo e tipo cliente ---\nconst nomeLimpoHost = (nomeHostCompleto || \"\").split(\" - \")[0].trim();\n\n\n\n// --- Retorno final ---\nreturn [\n  {\n    json: {\n      idEvento,\n      idHost,\n      nomeHostCompleto,\n      nomeEvento,\n      timestampQueda,\n      dataHoraQuedaFormatado,\n      nomeLimpoHost\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4992,560],"id":"b6b5b1d4-f404-4730-aae2-be0bac9de2eb","name":"Ajusta as informações do evento","retryOnFail":false,"disabled":true},{"parameters":{"jsCode":"const nomeLimpoHost = $input.first().json.nomeLimpoHost;\n\nlet nomePesquisaVariaveisGoogle = null;\nconst nomesMapeados = [\"INDIGO\", \"ALL4LABELS\", \"OLFAR\"];\n\n// Verifica se o nome do host contém algum dos nomes mapeados\nfor (const nome of nomesMapeados) {\n  if (nomeLimpoHost.toUpperCase().includes(nome)) {\n    nomePesquisaVariaveisGoogle = nome;\n    break;\n  }\n}\n\n// Se não encontrou nenhum nome mapeado, usa o próprio nomeLimpoHost\nif (!nomePesquisaVariaveisGoogle) {\n  nomePesquisaVariaveisGoogle = nomeLimpoHost;\n}\n\nreturn { nomePesquisaVariaveisGoogle };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5216,560],"id":"57a488bc-9c74-4176-8b8f-1ad44732a4e0","name":"Separa o trecho principal do nomeHost","disabled":true},{"parameters":{"tableId":"base","fieldsUi":{"fieldValues":[{"fieldId":"id_host","fieldValue":"={{ $('Ajusta as informações do evento').item.json.idHost }}"},{"fieldId":"nome_host","fieldValue":"={{ $('Ajusta as informações do evento').item.json.nomeHostCompleto }}"},{"fieldId":"timestamp_queda","fieldValue":"={{ $('Ajusta as informações do evento').item.json.timestampQueda }}"},{"fieldId":"status_chamado","fieldValue":"2"},{"fieldId":"id_evento","fieldValue":"={{ $('Ajusta as informações do evento').item.json.idEvento }}"},{"fieldId":"evento_raiz","fieldValue":"={{ $('Normaliza os dados').item.json['id do evento'] }}"},{"fieldId":"hostLimpo","fieldValue":"={{ $('Ajusta as informações do evento').item.json.nomeLimpoHost }}"},{"fieldId":"eventsRelacionados","fieldValue":"={{ $('Organiza os dados em arrays').item.json.eventosAtivos }}"},{"fieldId":"id_cliente_variaveis","fieldValue":"={{ $('Normaliza os dados').item.json['id do tipo de cliente no banco de dados'] }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5440,560],"id":"90703dc0-b48b-4771-85e5-5b43fee2bb05","name":"Supabase: Nova linha do chamado2","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}},"disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"ffb40bb0-034b-4b84-ab69-59c1f75dfa5c","name":"rEventRecuperacao","value":"={{ $json.rEventRecuperacao }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4544,560],"id":"0659db8c-9345-4c63-9b02-cc45e4e69b65","name":"Array de rEvents","disabled":true},{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[1168,320],"id":"2bc133ce-468e-4801-8d00-9c741fb9813e","name":"Quando executado o main"},{"parameters":{"assignments":{"assignments":[{"id":"6b3313e8-46f7-4c19-8cb3-5d6ec8efe31f","name":"timestampFormatado","value":"={{ DateTime.fromSeconds(parseInt($json.result[0].clock)).setZone(\"America/Sao_Paulo\").toFormat('dd/MM/yyyy HH:mm:ss') }}","type":"string"},{"id":"e7de0f40-874d-4a35-b0c4-e5337cdf6caa","name":"timestampRecovery","value":"={{ parseInt($json.result[0].clock) }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2432,-144],"id":"4e8a4ccb-59b6-42a9-8a58-7ff29aca73e5","name":"Ajusta data/hora Queda","disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"event.get\",\n  \"params\": {\n    \"output\": [\"clock\"],\n    \"eventids\": \"{{ $json.result[0].r_eventid }}\"\n  },\n  \"auth\": \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  \"id\": 1\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2192,-144],"id":"fda1ebb2-2e9b-4ec9-b2ce-7a859702cbfc","name":"Zabbix: Recupera clock do idRecovery","retryOnFail":true,"disabled":true},{"parameters":{"jsCode":"// --- Entrada / extração ---\nconst nomeHostCompleto = $('Zabbix: Recupera dados completos').first().json.result[0].hosts[0].name;\nconst nomeEvento = $('Zabbix: Recupera dados completos').first().json.result[0].name;\nconst idHost = Number($('Zabbix: Recupera dados completos').first().json.result[0].hosts[0].hostid) || null;\nconst statusAlerta = $('Zabbix: Recupera dados completos').first().json.result[0].relatedObject?.value == \"0\" ? \"Encerramento\" : \"Abertura Chamado\";\nconst idEventoRecovery = Number($('Zabbix: Recupera dados completos').first().json.result[0].r_eventid) || \"\";\nconst timestampQueda = Number($('Zabbix: Recupera dados completos').first().json.result[0].clock) || null;\nlet description = $('Zabbix: Recupera dados completos').first().json.result[0].hosts[0].description || \"\";\nconst idEvento = Number($('Zabbix: Recupera dados completos').first().json.result[0].eventid);\nconst dataHoraRecoveryFormatada = formatarTimestamp($input.first().json.timestampRecovery) || \"\";\nconst timestampRecovery = $input.first().json.timestampRecovery || \"\";\nconst tags = $('Zabbix: Recupera dados completos').first().json.result[0].tags;\n\n// --- Formata data (dd/MM/yyyy HH:mm:ss) com timezone São Paulo ---\nfunction formatarTimestamp(ts) {\n  if (!ts) return null;\n\n  const d = new Date(ts * 1000);\n\n  const dia = String(d.getDate()).padStart(2, \"0\");\n  const mes = String(d.getMonth() + 1).padStart(2, \"0\");\n  const ano = d.getFullYear();\n\n  const hora = String(d.getHours()).padStart(2, \"0\");\n  const min  = String(d.getMinutes()).padStart(2, \"0\");\n  const seg  = String(d.getSeconds()).padStart(2, \"0\");\n\n  return `${dia}/${mes}/${ano} ${hora}:${min}:${seg}`;\n}\nconst dataHoraQuedaFormatado = formatarTimestamp(timestampQueda);\n\n// --- Nome limpo e tipo cliente ---\nconst nomeLimpoHost = (nomeHostCompleto || \"\").split(\" - \")[0].trim();\n\n// --- Normaliza quebras literais e remove aspas extras ---\ndescription = description\n  .replace(/\\\\r\\\\n|\\\\n|\\\\r/g, '\\n')\n  .replace(/^\"+|\"+$/g, '') // remove aspas no início e fim\n  .replace(/\"\\s*\"\\s*/g, '\\n'); // separa blocos entre aspas\n\n// --- Divide em blocos começando por \"LINK\" ---\nfunction dividirPorBlocos(desc) {\n  if (!desc) return [];\n  const linhas = desc.split(/\\r?\\n/).map(l => l.trim()).filter(l => l !== \"\");\n  const blocos = [];\n  let blocoAtual = [];\n\n  for (const linha of linhas) {\n    if (linha.toUpperCase().startsWith(\"LINK\")) {\n      if (blocoAtual.length > 0) {\n        blocos.push(blocoAtual.join(\"\\n\"));\n        blocoAtual = [];\n      }\n    }\n    blocoAtual.push(linha);\n  }\n  if (blocoAtual.length > 0) blocos.push(blocoAtual.join(\"\\n\"));\n  return blocos;\n}\n\n// --- Parseia um bloco em campos estruturados ---\nfunction parsearBloco(bloco) {\n  const info = {};\n  const linhas = bloco.split(\"\\n\").map(l => l.trim());\n\n  for (const linha of linhas) {\n    const L = linha.toUpperCase();\n    if (L.startsWith(\"LINK\")) {\n      const match = linha.match(/LINK\\s+(.+?)\\s*-\\s*(.+)/i);\n      if (match) {\n        info.porta = match[1].trim();\n        info.operadora = match[2].trim();\n      } else {\n        const m2 = linha.match(/LINK\\s+(\\S+)/i);\n        if (m2) info.porta = m2[1].trim();\n      }\n    } else if (L.includes(\"UNIDADE:\")) {\n      info.unidade = linha.split(/UNIDADE:/i)[1].trim();\n    } else if (L.includes(\"ENDEREÇO:\") || L.includes(\"ENDERECO:\")) {\n      info.endereco = linha.split(/ENDEREÇO:|ENDERECO:/i)[1].trim();\n    } else if (L.includes(\"CNPJ:\")) {\n      info.cnpj = linha.split(/CNPJ:/i)[1].trim();\n    } else if (L.includes(\"DESIGNAÇÃO/CIRCUITO:\") || L.includes(\"DESIGNACAO/CIRCUITO:\")) {\n      info.designacao_circuito = linha.split(/DESIGNAÇÃO\\/CIRCUITO:|DESIGNACAO\\/CIRCUITO:/i)[1].trim();\n    } else if (L.startsWith(\"FW:\")) {\n      info.fw = linha.split(/FW:/i)[1].trim();\n    } else if (L.startsWith(\"IP:\")) {\n      info.ip = linha.split(/IP:/i)[1].trim();\n    } else if (L.includes(\"GEOP:\")) {\n      info.geop = linha.split(/GEOP:/i)[1].trim();\n    } else if (L.includes(\"TELEFONE UNIDADE:\") || L.includes(\"TELEFONE:\")) {\n      // captura tudo após o prefixo, mesmo se tiver \"-\"\n      info.telefone_unidade = linha.split(/TELEFONE UNIDADE:|TELEFONE:/i)[1].trim();\n    }\n  }\n\n  return info;\n}\n\n// --- Executa parsing e corrige unidade inválida ---\nconst blocosTexto = dividirPorBlocos(description);\nconst blocos = blocosTexto.map(parsearBloco).map(info => {\n  if (!info.unidade || [\"NAN\", \"NA\", \"N/A\", \"-\"].includes(info.unidade.trim().toUpperCase())) {\n    const partesHost = nomeHostCompleto.split(\" - \");\n    if (partesHost.length > 1) {\n      const unidadePossivel = partesHost[1].replace(/LINK.+/i, \"\").trim();\n      info.unidade = unidadePossivel || nomeLimpoHost;\n    } else {\n      info.unidade = nomeLimpoHost;\n    }\n  }\n  return info;\n});\n\nconst tagsFiltradas = Array();\nfor (const tag of tags) {\n  if (tag.tag.toLowerCase() == 'aplicacao' || tag.tag.toLowerCase() == 'noc') {\n    tagsFiltradas.push(tag)\n  }\n}\n\n\n\n// --- Retorno final ---\nreturn [\n  {\n    json: {\n      idEvento,\n      idHost,\n      nomeHostCompleto,\n      nomeEvento,\n      timestampQueda,\n      dataHoraQuedaFormatado,\n      nomeLimpoHost,\n      statusAlerta,\n      idEventoRecovery,\n      timestampRecovery,\n      dataHoraRecoveryFormatada,\n      blocos,\n      tagsFiltradas\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2688,-144],"id":"210fa9a5-754b-4203-af01-dc892ecc89d9","name":"Ajusta as informações do evento1","retryOnFail":false,"disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"host.get\",\n  \"params\": {\n    \"output\": [\"hostid\", \"name\"],\n    \"selectGroups\": [\"groupid\", \"name\"],\n    \"hostids\": \"{{ $('Normaliza os dados').item.json['id do host'] }}\"\n  },\n  \"auth\": \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  \"id\": 2\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1952,-176],"id":"279bdf27-4266-4d5f-8a6c-cbb59689aea1","name":"Zabbix: Consulta grupo do host","retryOnFail":true,"disabled":true},{"parameters":{"operation":"get","tableId":"base","filters":{"conditions":[{"keyName":"id_evento","keyValue":"={{ $json[\"id do evento\"] }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1376,320],"id":"8b7a8b60-a8cc-4d94-b26f-9bd223071e24","name":"Supabase: Recupera correspondência","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d776d7a-04d8-4a32-aeb0-56e51ec129ef","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1584,320],"id":"8da17d75-2806-4170-92e0-92be0e362bc5","name":"Existe evento no BD?"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1840,448],"id":"916c6c8a-f3c9-4fc5-a92e-52ceacb471ca","name":"No Ops"},{"parameters":{"jsCode":"const hostCompleto = $input.first().json.nome_host;\n\n// --- 1. Extrair somente a primeira parte antes do \" - \" ---\nlet nomeHostBase = hostCompleto.split(\" - \")[0].trim();\n\n// --- 2. Lógica para mapear nomes especiais ---\nlet nomePesquisaDeVariaveis = null;\nconst nomesMapeados = [\"INDIGO\", \"ALL4LABELS\"];\n\n// Verifica se o nomeHostBase contém algum dos nomes mapeados\nfor (const nome of nomesMapeados) {\n  if (nomeHostBase.toUpperCase().includes(nome)) {\n    nomePesquisaDeVariaveis = nome;\n    break;\n  }\n}\n\n// Se não encontrou nenhum nome mapeado, usa o próprio nomeHostBase\nif (!nomePesquisaDeVariaveis) {\n  nomePesquisaDeVariaveis = nomeHostBase;\n}\n\nreturn { nomePesquisaDeVariaveis };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1840,208],"id":"2e8e41bc-ef60-4ca8-ad60-37de0f3048e2","name":"Separa o trecho principal do host"},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"11ynejkll5Q6J6AJ--R3sIxLMyyd3AbTaTS9ncm1KQMs","mode":"list","cachedResultName":"Dados_automação ","cachedResultUrl":"https://docs.google.com/spreadsheets/d/11ynejkll5Q6J6AJ--R3sIxLMyyd3AbTaTS9ncm1KQMs/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":195655548,"mode":"list","cachedResultName":"Contatos_n8n","cachedResultUrl":"https://docs.google.com/spreadsheets/d/11ynejkll5Q6J6AJ--R3sIxLMyyd3AbTaTS9ncm1KQMs/edit#gid=195655548"},"filtersUI":{"values":[{"lookupColumn":"EMPRESA","lookupValue":"={{ $json.nomePesquisaDeVariaveis }}"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2048,208],"id":"b142f456-5d84-4726-aec4-db82130778b1","name":"Sheet: Pesquisa variáveis do cliente","alwaysOutputData":true,"credentials":{"googleApi":{"id":"G23Xn5Fl7KzKph4r","name":"Google Service Account account"}}},{"parameters":{"operation":"get","tableId":"variaveis_cliente","filters":{"conditions":[{"keyName":"nome_variavel","keyValue":"={{ $json[\"RELAÇÃO\"] }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2256,208],"id":"7bdd417b-1d80-4318-b367-94e342c8016f","name":"Supabase: Recupera tipoCliente","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.id }}","rightValue":1,"operator":{"type":"number","operation":"equals"},"id":"1a2fb722-52af-41fe-bf11-ae4a2d231355"}],"combinator":"and"},"renameOutput":true,"outputKey":"CONTRATO 1"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d7e18f65-054c-4518-9581-70d6d3e9f4c4","leftValue":"={{ $json.id }}","rightValue":2,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"CONTRATO 2"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2464491c-9a06-4c1e-9f67-db7551a61253","leftValue":"={{ $json.id }}","rightValue":3,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ALERTAS GERAIS"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[2464,192],"id":"f7485b1e-b806-485c-913a-87d54999a1a9","name":"Rota tipoChamado"}],"connections":{"Prepara os dados para vários eventos":{"main":[[{"node":"Existem dois eventos ou mais?","type":"main","index":0}]]},"Existem dois eventos ou mais?":{"main":[[{"node":"Zabbix: Consulta dados de n eventos","type":"main","index":0}],[{"node":"Supabase: Atualiza encerramento do evento","type":"main","index":0}]]},"Ajusta informação de encerramento para n eventos":{"main":[[{"node":"Movidesk: Notifica encerramento","type":"main","index":0}]]},"Zabbix: Consulta dados de n eventos":{"main":[[{"node":"Organiza os dados em arrays","type":"main","index":0}]]},"Zabbix: Recupera o clock dos eventos":{"main":[[{"node":"Ajusta informação de encerramento para n eventos","type":"main","index":0}]]},"Movidesk: Notifica encerramento":{"main":[[{"node":"Aguarda","type":"main","index":0}]]},"Movidesk: Encerra ticket no Movidesk":{"main":[[{"node":"Notifica encerramento","type":"main","index":0}]]},"Supabase: Atualiza timestamp de recuperação":{"main":[[{"node":"Prepara os dados para vários eventos","type":"main","index":0}]]},"Supabase: Atualiza encerramento do evento":{"main":[[{"node":"Movidesk: Notifica encerramento","type":"main","index":0}]]},"Aguarda":{"main":[[{"node":"Prepara dados para encerramento ","type":"main","index":0}]]},"Prepara dados para encerramento ":{"main":[[{"node":"Movidesk: Encerra ticket no Movidesk","type":"main","index":0}]]},"Consulta dados do evento no Zabbix":{"main":[[{"node":"Ajusta as informações do evento","type":"main","index":0}]]},"Prepara dados para abertura de chamado1":{"main":[[{"node":"Movidesk: Notifica indisponibilidade1","type":"main","index":0}]]},"Organiza os dados em arrays":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Array de rEvents","type":"main","index":0}],[{"node":"Zabbix: Recupera o clock dos eventos","type":"main","index":0}]]},"Ajusta as informações do evento":{"main":[[{"node":"Separa o trecho principal do nomeHost","type":"main","index":0}]]},"Separa o trecho principal do nomeHost":{"main":[[{"node":"Supabase: Nova linha do chamado2","type":"main","index":0}]]},"Supabase: Nova linha do chamado2":{"main":[[{"node":"Prepara dados para abertura de chamado1","type":"main","index":0}]]},"Array de rEvents":{"main":[[{"node":"Consulta dados do evento no Zabbix","type":"main","index":0}]]},"Zabbix: Recupera clock do idRecovery":{"main":[[{"node":"Ajusta data/hora Queda","type":"main","index":0}]]},"Quando executado o main":{"main":[[{"node":"Supabase: Recupera correspondência","type":"main","index":0}]]},"Supabase: Recupera correspondência":{"main":[[{"node":"Existe evento no BD?","type":"main","index":0}]]},"Existe evento no BD?":{"main":[[{"node":"Separa o trecho principal do host","type":"main","index":0}],[{"node":"No Ops","type":"main","index":0}]]},"Separa o trecho principal do host":{"main":[[{"node":"Sheet: Pesquisa variáveis do cliente","type":"main","index":0}]]},"Sheet: Pesquisa variáveis do cliente":{"main":[[{"node":"Supabase: Recupera tipoCliente","type":"main","index":0}]]},"Supabase: Recupera tipoCliente":{"main":[[{"node":"Rota tipoChamado","type":"main","index":0}]]},"Rota tipoChamado":{"main":[[],[],[{"node":"Supabase: Atualiza timestamp de recuperação","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Quando executado o main":[{"json":{"id do evento":174072387,"id do evento de recuperação":174122516,"id do host":20488,"timestamp da queda":1763119370,"data e hora da queda":"14/11/2025 08:22:50","nome do host":"UTC TABACO MATRIZ - LINK X2 AVATO 200MB - 187.60.190.210","evento gerador":"Indisponível via ICMP","reconhecimentos do alerta":[{"acknowledgeid":"21474","eventid":"174072387","clock":"1763121110","message":"130962","action":"6"}],"tags do alerta":[{"tag":"Alerta","value":"ICMP"},{"tag":"Aplicação","value":"ICMP"},{"tag":"Template","value":"ICMP"}]}}]},"versionId":"d76b2b27-da1a-4a9a-a114-d928989cce51","activeVersionId":"d76b2b27-da1a-4a9a-a114-d928989cce51","triggerCount":0,"shared":[{"updatedAt":"2025-11-28T01:15:17.055Z","createdAt":"2025-11-28T01:15:17.055Z","role":"workflow:owner","workflowId":"ZVeD95d6p3HW0csG","projectId":"UcF1WBdewsFeRVFr"}],"activeVersion":{"updatedAt":"2026-01-27T16:47:39.129Z","createdAt":"2026-01-27T16:47:39.129Z","versionId":"d76b2b27-da1a-4a9a-a114-d928989cce51","workflowId":"ZVeD95d6p3HW0csG","nodes":[{"parameters":{"jsCode":"const eventosRelacionados = $input.first().json.eventsRelacionados\n\nlet rotaEventosRelacionados = null;\nif (eventosRelacionados.length >= 2) {\n  rotaEventosRelacionados = true;\n} else {\n  rotaEventosRelacionados = false;\n}\n\n\nreturn [\n  {\n    eventosRelacionados,\n    rotaEventosRelacionados\n  }\n]"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3424,752],"id":"63838c2c-9ad5-46e0-abd9-7bc4df7e5b83","name":"Prepara os dados para vários eventos","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2df73fb5-8791-48c0-88fb-d345f41813ef","leftValue":"={{ $json.rotaEventosRelacionados }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3648,752],"id":"bffbc3a7-8df7-494c-9a40-5af420a03d1c","name":"Existem dois eventos ou mais?","disabled":true},{"parameters":{"jsCode":"const resultadoConsultaClock = $input.first().json.result;\nconst arrayHosts = $('Organiza os dados em arrays').first().json.hosts;\nconst arrayEventos = $('Organiza os dados em arrays').first().json.eventos;\n\nconst arrayClocks = [];\nfor (const consultaClock of resultadoConsultaClock) {\n  arrayClocks.push(consultaClock.clock);\n}\n\n// ==== RETORNA GREETING CONFORME HORÁRIO ATUAL EM SÃO PAULO ====\nfunction getGreeting() {\n  const horaSaoPaulo = new Date().toLocaleString(\"en-US\", { timeZone: \"America/Sao_Paulo\" });\n  const hora = new Date(horaSaoPaulo).getHours();\n\n  if (hora >= 18 || hora < 5) return \"Boa noite\";\n  if (hora >= 5 && hora < 12) return \"Bom dia\";\n  return \"Boa tarde\";\n}\nconst greeting = getGreeting();\n\n// ==== CONVERTE TIMESTAMP PARA FORMATO BR ====\nfunction formatarData(timestamp) {\n  const dateFormatada = DateTime.fromSeconds(Number(timestamp)).setZone('America/Sao_Paulo').toFormat('dd/MM/yyyy - HH:mm:ss');\n\n  return dateFormatada\n}\n\n// ==== MONTAGEM DA LINHA DA TABELA ====\nfunction montaLinhaTabela(arrayHosts, arrayEventos, arrayClocks) {\n  let linhasTabela = \"\";\n\n  for (let i = 0; i < arrayHosts.length; i++) {\n    const host = arrayHosts[i] || \"-\";\n    const evento = arrayEventos[i] || \"-\";\n    const dataHora = arrayClocks[i] ? formatarData(arrayClocks[i]) : \"-\";\n    \n    linhasTabela += `\n      <tr>\n        <td>${host}</td>\n        <td>${evento}</td>\n        <td>${dataHora}</td>\n      </tr>\n    `;\n  }\n\n  return linhasTabela;\n}\n\n\n\n// ===== PREPARAÇÃO PARA NOTIFICAÇÃO DE ENCERRAMENTO DE CHAMADO ====\nconst htmlCliente = `\n  <p>${greeting}</p>\n  <br>\n  <p>O seguinte alerta consta como restabelecido em nosso sistema de monitoramento:</p>\n  \n  <div style=\"width: 90%; padding: 10px; margin:10px 0; text-align: center; align-items: center;\">\n    <table border=\"1\" cellspacing=\"0\" cellpadding=\"5\" style=\"width:100%\">\n      <thead>\n          <tr>\n            <th>Hosts</th>\n            <th>Eventos</th>\n            <th>Horário das quedas</th>\n            <th>Horário do restabelecimento</th>\n          </tr>\n      </thead>\n      <tbody>\n          ${montaLinhaTabela(arrayHosts, arrayEventos, arrayClocks)}\n      </tbody>\n    </table>\n  </div>\n  <p>Permanecemos à disposição</p>\n  <br>\n  \n  <p>Atenciosamente,</p>\n  <img src=\"https://s3.amazonaws.com/movidesk-files/F63A932F58073D98A6D18347DEE480C5?AWSAccessKeyId=AKIAWSRCTWGBHCVKCQGD&Expires=1762462132&Signature=q%2FTkmFvX5ZyV4Id96xCPLnHgNzs%3D\">\n`;\n\n// ==== RETORNO FINAL ====\nreturn {\n  json: {\n    actions: [\n      {\n        type: 2,\n        description: htmlCliente,\n        createdBy: { id: \"1458772347\" },\n        workTime: \"00:02:00\"\n      }\n    ]\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4768,752],"id":"4b824536-be28-4959-bb50-899430f154ea","name":"Ajusta informação de encerramento para n eventos","disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"event.get\",\n  \"params\": {\n    \"output\": [\"eventid\", \"name\", \"r_eventid\"],\n    \"eventids\": [{{ $json.eventosRelacionados }}],\n\n    \"selectHosts\": [\"hostid\", \"name\", \"description\"],\n\n    \"selectRelatedObject\": [\n      \"description\",\n      \"value\"\n    ]\n  },\n  \"auth\": \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  \"id\": 1\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3872,656],"id":"d62ece49-174e-4344-98c0-69fdf14ebab3","name":"Zabbix: Consulta dados de n eventos","retryOnFail":true,"disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"event.get\",\n  \"params\": {\n    \"output\": [\"eventid\", \"clock\"],\n    \"eventids\": [{{$json.rEventRecuperacao}}],\n    \"selectHosts\": [\"name\"]\n  },\n  \"auth\": \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  \"id\": 1\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4544,752],"id":"005482a4-04cd-4dfc-a8d5-01fa07a59dea","name":"Zabbix: Recupera o clock dos eventos","retryOnFail":true,"disabled":true},{"parameters":{"method":"PATCH","url":"=https://atendimento.maxprotection.com.br/public/v1/tickets?token=538206c9-60b4-4bf4-ae85-415ab9a68be6&id={{ $('Supabase: Recupera correspondências1').item.json.ticket_movidesk }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4992,848],"id":"3e0f6f22-673b-4912-ba6a-7ffbabbe2982","name":"Movidesk: Notifica encerramento","retryOnFail":true,"disabled":true},{"parameters":{"method":"PATCH","url":"=https://atendimento.maxprotection.com.br/public/v1/tickets?token=538206c9-60b4-4bf4-ae85-415ab9a68be6&id={{ $('Supabase: Recupera correspondências1').item.json.ticket_movidesk }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5664,848],"id":"3f0efa96-2e12-46dd-875b-ec93fb56d4ad","name":"Movidesk: Encerra ticket no Movidesk","retryOnFail":true,"disabled":true},{"parameters":{"operation":"update","tableId":"base","matchType":"allFilters","filters":{"conditions":[{"keyName":"id_evento","condition":"eq","keyValue":"={{ $('Quando executado o main').item.json[\"id do evento\"] }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"id_evento_recuperacao","fieldValue":"={{ $('Normaliza os dados').item.json['timestamp da recuperação'] }}"},{"fieldId":"status_chamado","fieldValue":"5"},{"fieldId":"timestampRecuperacao","fieldValue":"={{ $('Normaliza os dados').item.json['timestamp da recuperação'] }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3200,752],"id":"827d4489-d7ef-439b-afd2-a70c4b24ef80","name":"Supabase: Atualiza timestamp de recuperação","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}}},{"parameters":{"jsCode":"const nomeHost = $('Normaliza os dados').first().json['nome completo do host'];\nconst nomeEvento = $('Normaliza os dados').first().json['evento gerador'];\nconst dataHoraQueda_formatada = $('Normaliza os dados').first().json['data e hora da queda']\nconst dataHoraRestabelecimento_formatada = $('Normaliza os dados').first().json['data e hora da recuperação'];\n\n\n// ==== RETORNA GREETING CONFORME HORÁRIO ATUAL EM SÃO PAULO ====\nfunction getGreeting() {\n  // Obtém o horário atual diretamente no fuso horário de São Paulo\n  const agora = new Date().toLocaleString(\"pt-BR\", { timeZone: \"America/Sao_Paulo\" });\n  const horaAtual = new Date(agora).getHours();\n\n  if (horaAtual >= 18 || horaAtual < 5) {\n    return \"Boa noite\";\n  } else if (horaAtual >= 5 && horaAtual < 12) {\n    return \"Bom dia\";\n  } else {\n    return \"Boa tarde\";\n  }\n};\nconst greeting = getGreeting();\n\n\n// ==== MONTAGEM DA LINHA DA TABELA ====\nfunction montaLinhaTabela(host, evento, quedaFormatada, restabelecimentoFormatado) {\n  let linhasTabela = `\n    <td>${host}</td>\n    <td>${evento}</td>\n    <td>${quedaFormatada}</td>\n    <td>${restabelecimentoFormatado}</td>\n  `;\n\n  return linhasTabela;\n};\n\n\n// ===== PREPARAÇÃO PARA NOTIFICAÇÃO DE ENCERRAMENTO DE CHAMADO ====\nconst htmlCliente = `\n  <p>${greeting}</p>\n  <br>\n  <p>O seguinte alerta consta como restabelecido em nosso sistema de monitoramento:</p>\n  \n  <div style=\"width: 90%; padding: 10px; margin:10px 0; text-align: center; align-items: center;\">\n    <table border=\"1\" cellspacing=\"0\" cellpadding=\"5\" style=\"width:100%\">\n      <thead>\n          <tr>\n            <th>Hosts</th>\n            <th>Eventos</th>\n            <th>Horário das quedas</th>\n            <th>Horário do restabelecimento</th>\n          </tr>\n      </thead>\n      <tbody>\n          ${montaLinhaTabela(nomeHost, nomeEvento, dataHoraQueda_formatada, dataHoraRestabelecimento_formatada)}\n      </tbody>\n    </table>\n  </div>\n  <p>Permanecemos à disposição</p>\n  <br>\n  \n  <p>Atenciosamente,</p>\n  <img src=\"https://s3.amazonaws.com/movidesk-files/F63A932F58073D98A6D18347DEE480C5?AWSAccessKeyId=AKIAWSRCTWGBHCVKCQGD&Expires=1762462132&Signature=q%2FTkmFvX5ZyV4Id96xCPLnHgNzs%3D\">\n`;\n\n// ==== RETORNO QUE SERÁ USADO PELO HTTPREQUEST NO PRÓXIMO NÓ ====\nreturn {\n  json: {\n    actions: [\n      {\n        type: 2,\n        description: htmlCliente,\n        createdBy: { id: \"1458772347\" },\n        workTime: \"00:02:00\"\n      }\n    ]\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4768,944],"id":"9ebef0f7-284e-43e5-a6e6-ffb2c3c05cff","name":"Supabase: Atualiza encerramento do evento","disabled":true},{"parameters":{"amount":1.5},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[5216,848],"id":"ea335427-d70e-46de-b4a7-83a78d0fbb88","name":"Aguarda","webhookId":"3412b67e-a067-45e3-8c98-ea268685dee3","disabled":true},{"parameters":{"jsCode":"return {\n  json: {\n    status: \"Resolvido\",\n    baseStatus: \"Closed\", //\"Stopped\"\n    justification: null, //\"Validação\"\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5440,848],"id":"91db6554-a29a-46a3-88bf-f989c0aeef63","name":"Prepara dados para encerramento ","disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"event.get\",\n  \"params\": {\n    \"output\": [\"eventid\", \"clock\", \"name\"],\n    \"eventids\": \"{{ $json.rEventRecuperacao[0] }}\",\n\n    \"selectHosts\": [\"hostid\", \"name\", \"description\"],\n\n    \"select_acknowledges\": [\n      \"acknowledgeid\",\n      \"eventid\",\n      \"clock\",\n      \"message\",\n      \"action\"\n    ],\n\n    \"selectRelatedObject\": [\n      \"triggerid\",\n      \"description\",\n      \"value\",\n      \"priority\"\n    ]\n  },\n  \"auth\": \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  \"id\": 1\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4768,560],"id":"95211466-8872-4cbd-bea5-86c6d93b5be6","name":"Consulta dados do evento no Zabbix","retryOnFail":true,"disabled":true},{"parameters":{"method":"POST","url":"=https://atendimento.maxprotection.com.br/public/v1/tickets?token=538206c9-60b4-4bf4-ae85-415ab9a68be6","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5888,560],"id":"3b8e1545-c4e0-4639-9aaf-8f52658f790d","name":"Movidesk: Notifica indisponibilidade1","retryOnFail":true,"disabled":true},{"parameters":{"jsCode":"const nomeHost = $('Ajusta as informações do evento').first().json.nomeHostCompleto;\nconst nomeEvento = $('Ajusta as informações do evento').first().json.nomeEvento;\nconst dataHoraFormatada = $('Ajusta as informações do evento').first().json.dataHoraQuedaFormatado;\nconst idMovideskAberturaTickets = $('Normaliza os dados').first().json['id de abertura de chamado no movidesk'];\nlet copiaTicketMovidesk = $('Normaliza os dados').first().json['e-mail em cópia'];\nconst ticketMovideskAnterior = $('Supabase: Recupera correspondências1').first().json.ticket_movidesk;\n\nif (copiaTicketMovidesk == \"\") {\n  copiaTicketMovidesk = \"\"\n} else {\n  copiaTicketMovidesk\n};\n\n// ==== RETORNA GREETING CONFORME HORÁRIO ATUAL EM SÃO PAULO ====\nfunction getGreeting() {\n  const horaSaoPaulo = new Date().toLocaleString(\"en-US\", { timeZone: \"America/Sao_Paulo\" });\n  const hora = new Date(horaSaoPaulo).getHours();\n\n  if (hora >= 18 || hora < 5) return \"Boa noite\";\n  if (hora >= 5 && hora < 12) return \"Bom dia\";\n  return \"Boa tarde\";\n}\nconst greeting = getGreeting();\n\n// ==== MONTAGEM DA LINHA DA TABELA ====\nfunction montaLinhaTabela(host, evento, quedaEm) {\n  let linhasTabela = `\n    <tr>\n      <td>${host}</td>\n      <td>${evento}</td>\n      <td>${quedaEm}</td>\n    </tr>\n  `;\n  \n  return linhasTabela;\n}\n\n\n\n// ==== VARIÁVEIS DO CLIENTE =====\nconst idCliente = idMovideskAberturaTickets // para teste: \"1836303904\";\nconst emCopiaPara = copiaTicketMovidesk;\n\n\n// ===== PREPARAÇÃO PARA NOTIFICAÇÃO DE ENCERRAMENTO DE CHAMADO ====\nconst htmlCliente = `\n  <p>${greeting}</p>\n  <br>\n  <p>O alerta associado ao ticket ${ticketMovideskAnterior} já havia sido reportado. No momento, ele continua indisponível, enquanto os demais alertas já foram normalizados e notificados.</p>\n  \n  <div style=\"width: 90%; padding: 10px; margin:10px 0; text-align: center; align-items: center;\">\n    <table border=\"1\" cellspacing=\"0\" cellpadding=\"5\" style=\"width:100%\">\n      <thead>\n          <tr>\n            <th>Hosts</th>\n            <th>Eventos</th>\n            <th>Horário das quedas</th>\n          </tr>\n      </thead>\n      <tbody>\n          ${montaLinhaTabela(nomeHost, nomeEvento, dataHoraFormatada)}\n      </tbody>\n    </table>\n  </div>\n  <p>Permanecemos à disposição</p>\n  <br>\n  \n  <p>Atenciosamente,</p>\n  <img src=\"https://s3.amazonaws.com/movidesk-files/F63A932F58073D98A6D18347DEE480C5?AWSAccessKeyId=AKIAWSRCTWGBHCVKCQGD&Expires=1762462132&Signature=q%2FTkmFvX5ZyV4Id96xCPLnHgNzs%3D\">\n`;\n\n\n// ==== RETORNO QUE SERÁ USADO PELO HTTPREQUEST NO PRÓXIMO NÓ ====\nreturn {\n  json: {\n    type: 2,\n    subject: `REPARO - ${nomeHost}`,\n    category: \"01 - Atendimento Helpdesk\",\n    serviceFirstLevelId: 325878,\n    urgency: \"Média\",\n    ownerTeam: \"NOC\",\n    status: \"Aguardando\",\n    justification: \"Validação\",\n    createdBy: { id: \"1458772347\" },\n    Clients: [{ id: idCliente }],\n    cc: emCopiaPara,\n    actions: [\n      { type: 2, description: htmlCliente, createdBy: { id: \"1458772347\" } }\n    ]\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5664,560],"id":"dd521508-c73b-4e20-bb18-ffd0356dab4f","name":"Prepara dados para abertura de chamado1","disabled":true},{"parameters":{"authentication":"webhook","content":"=","options":{},"embeds":{"values":[{"description":"=O seguinte alerta foi encerrado e o cliente notificado\n\n**HOST:** {{ $('Normaliza os dados').item.json['nome completo do host'] }}\n**EVENTO:** {{ $('Normaliza os dados').item.json['evento gerador'] }}\n**DATA E HORA DA QUEDA:** {{ $('Normaliza os dados').item.json['data e hora da queda'] }}\n**DATA E HORA DO RESTABELECIMENTO:** {{ $('Normaliza os dados').item.json['data e hora da recuperação'] }}\n\n**TICKET MOVIDESK:** {{ $('Supabase: Recupera correspondências1').item.json.ticket_movidesk }}","color":"#69BF6C","title":"TICKET ENCERRADO!","thumbnail":"https://imagepng.org/wp-content/uploads/2019/12/check-icone-scaled.png"}]}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[5888,848],"id":"a7215dbe-8a59-4041-aaef-ec66c40bc133","name":"Notifica encerramento","webhookId":"5602e92a-bce3-4895-9977-2ff14b2bfc30","retryOnFail":true,"credentials":{"discordWebhookApi":{"id":"lA2qaXo0Uc6Pobsl","name":"Canal: encerramento de chamado"}},"disabled":true},{"parameters":{"jsCode":"const resultados = $input.first().json.result;\n\nlet hosts = [];\nlet eventos = [];\nlet rEventRecuperacao = [];\nlet eventosAtivos = [];\n\nfor (const resultado of resultados) {\n  if (parseInt(resultado.r_eventid) >= 1 && parseInt(resultado.relatedObject.value) == 0) {\n    hosts.push(resultado.hosts[0].name);\n    eventos.push(resultado.name);\n    rEventRecuperacao.push(resultado.r_eventid);\n  } else if (parseInt(resultado.r_eventid) == 0 && parseInt(resultado.relatedObject.value) == 1) {\n    eventosAtivos.push(resultado.eventid)\n  }\n}\n\nreturn [\n  {\n    hosts,\n    eventos,\n    rEventRecuperacao,\n    eventosAtivos\n  }\n]"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4096,656],"id":"7333c62e-5d07-4e16-8ebe-18d612f49bb1","name":"Organiza os dados em arrays","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"881a983b-8175-4fde-9f88-29171f05d83c","leftValue":"={{ $json.eventosAtivos }}","rightValue":1,"operator":{"type":"array","operation":"lengthGte","rightType":"number"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[4320,656],"id":"8a24e4aa-139e-4829-a5e2-1354dc3633b5","name":"If","disabled":true},{"parameters":{"jsCode":"// --- Entrada / extração ---\nconst nomeHostCompleto = $input.first().json.result[0].hosts[0].name;\nconst nomeEvento = $input.first().json.result[0].relatedObject.description;\nconst idHost = parseInt($input.first().json.result[0].hosts[0].hostid) || null;\nconst timestampQueda = parseInt($input.first().json.result[0].clock) || null;\nconst idEvento = parseInt($input.first().json.result[0].eventid);\n\n// --- Formata data (dd/MM/yyyy HH:mm:ss) com timezone São Paulo ---\nfunction formatarTimestamp(ts) {\n  if (!ts) return null;\n  return new Intl.DateTimeFormat(\"pt-BR\", {\n    timeZone: \"America/Sao_Paulo\",\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: false\n  }).format(new Date(ts * 1000));\n}\nconst dataHoraQuedaFormatado = formatarTimestamp(timestampQueda);\n\n// --- Nome limpo e tipo cliente ---\nconst nomeLimpoHost = (nomeHostCompleto || \"\").split(\" - \")[0].trim();\n\n\n\n// --- Retorno final ---\nreturn [\n  {\n    json: {\n      idEvento,\n      idHost,\n      nomeHostCompleto,\n      nomeEvento,\n      timestampQueda,\n      dataHoraQuedaFormatado,\n      nomeLimpoHost\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4992,560],"id":"b6b5b1d4-f404-4730-aae2-be0bac9de2eb","name":"Ajusta as informações do evento","retryOnFail":false,"disabled":true},{"parameters":{"jsCode":"const nomeLimpoHost = $input.first().json.nomeLimpoHost;\n\nlet nomePesquisaVariaveisGoogle = null;\nconst nomesMapeados = [\"INDIGO\", \"ALL4LABELS\", \"OLFAR\"];\n\n// Verifica se o nome do host contém algum dos nomes mapeados\nfor (const nome of nomesMapeados) {\n  if (nomeLimpoHost.toUpperCase().includes(nome)) {\n    nomePesquisaVariaveisGoogle = nome;\n    break;\n  }\n}\n\n// Se não encontrou nenhum nome mapeado, usa o próprio nomeLimpoHost\nif (!nomePesquisaVariaveisGoogle) {\n  nomePesquisaVariaveisGoogle = nomeLimpoHost;\n}\n\nreturn { nomePesquisaVariaveisGoogle };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5216,560],"id":"57a488bc-9c74-4176-8b8f-1ad44732a4e0","name":"Separa o trecho principal do nomeHost","disabled":true},{"parameters":{"tableId":"base","fieldsUi":{"fieldValues":[{"fieldId":"id_host","fieldValue":"={{ $('Ajusta as informações do evento').item.json.idHost }}"},{"fieldId":"nome_host","fieldValue":"={{ $('Ajusta as informações do evento').item.json.nomeHostCompleto }}"},{"fieldId":"timestamp_queda","fieldValue":"={{ $('Ajusta as informações do evento').item.json.timestampQueda }}"},{"fieldId":"status_chamado","fieldValue":"2"},{"fieldId":"id_evento","fieldValue":"={{ $('Ajusta as informações do evento').item.json.idEvento }}"},{"fieldId":"evento_raiz","fieldValue":"={{ $('Normaliza os dados').item.json['id do evento'] }}"},{"fieldId":"hostLimpo","fieldValue":"={{ $('Ajusta as informações do evento').item.json.nomeLimpoHost }}"},{"fieldId":"eventsRelacionados","fieldValue":"={{ $('Organiza os dados em arrays').item.json.eventosAtivos }}"},{"fieldId":"id_cliente_variaveis","fieldValue":"={{ $('Normaliza os dados').item.json['id do tipo de cliente no banco de dados'] }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5440,560],"id":"90703dc0-b48b-4771-85e5-5b43fee2bb05","name":"Supabase: Nova linha do chamado2","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}},"disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"ffb40bb0-034b-4b84-ab69-59c1f75dfa5c","name":"rEventRecuperacao","value":"={{ $json.rEventRecuperacao }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4544,560],"id":"0659db8c-9345-4c63-9b02-cc45e4e69b65","name":"Array de rEvents","disabled":true},{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[1168,320],"id":"2bc133ce-468e-4801-8d00-9c741fb9813e","name":"Quando executado o main"},{"parameters":{"assignments":{"assignments":[{"id":"6b3313e8-46f7-4c19-8cb3-5d6ec8efe31f","name":"timestampFormatado","value":"={{ DateTime.fromSeconds(parseInt($json.result[0].clock)).setZone(\"America/Sao_Paulo\").toFormat('dd/MM/yyyy HH:mm:ss') }}","type":"string"},{"id":"e7de0f40-874d-4a35-b0c4-e5337cdf6caa","name":"timestampRecovery","value":"={{ parseInt($json.result[0].clock) }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2432,-144],"id":"4e8a4ccb-59b6-42a9-8a58-7ff29aca73e5","name":"Ajusta data/hora Queda","disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"event.get\",\n  \"params\": {\n    \"output\": [\"clock\"],\n    \"eventids\": \"{{ $json.result[0].r_eventid }}\"\n  },\n  \"auth\": \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  \"id\": 1\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2192,-144],"id":"fda1ebb2-2e9b-4ec9-b2ce-7a859702cbfc","name":"Zabbix: Recupera clock do idRecovery","retryOnFail":true,"disabled":true},{"parameters":{"jsCode":"// --- Entrada / extração ---\nconst nomeHostCompleto = $('Zabbix: Recupera dados completos').first().json.result[0].hosts[0].name;\nconst nomeEvento = $('Zabbix: Recupera dados completos').first().json.result[0].name;\nconst idHost = Number($('Zabbix: Recupera dados completos').first().json.result[0].hosts[0].hostid) || null;\nconst statusAlerta = $('Zabbix: Recupera dados completos').first().json.result[0].relatedObject?.value == \"0\" ? \"Encerramento\" : \"Abertura Chamado\";\nconst idEventoRecovery = Number($('Zabbix: Recupera dados completos').first().json.result[0].r_eventid) || \"\";\nconst timestampQueda = Number($('Zabbix: Recupera dados completos').first().json.result[0].clock) || null;\nlet description = $('Zabbix: Recupera dados completos').first().json.result[0].hosts[0].description || \"\";\nconst idEvento = Number($('Zabbix: Recupera dados completos').first().json.result[0].eventid);\nconst dataHoraRecoveryFormatada = formatarTimestamp($input.first().json.timestampRecovery) || \"\";\nconst timestampRecovery = $input.first().json.timestampRecovery || \"\";\nconst tags = $('Zabbix: Recupera dados completos').first().json.result[0].tags;\n\n// --- Formata data (dd/MM/yyyy HH:mm:ss) com timezone São Paulo ---\nfunction formatarTimestamp(ts) {\n  if (!ts) return null;\n\n  const d = new Date(ts * 1000);\n\n  const dia = String(d.getDate()).padStart(2, \"0\");\n  const mes = String(d.getMonth() + 1).padStart(2, \"0\");\n  const ano = d.getFullYear();\n\n  const hora = String(d.getHours()).padStart(2, \"0\");\n  const min  = String(d.getMinutes()).padStart(2, \"0\");\n  const seg  = String(d.getSeconds()).padStart(2, \"0\");\n\n  return `${dia}/${mes}/${ano} ${hora}:${min}:${seg}`;\n}\nconst dataHoraQuedaFormatado = formatarTimestamp(timestampQueda);\n\n// --- Nome limpo e tipo cliente ---\nconst nomeLimpoHost = (nomeHostCompleto || \"\").split(\" - \")[0].trim();\n\n// --- Normaliza quebras literais e remove aspas extras ---\ndescription = description\n  .replace(/\\\\r\\\\n|\\\\n|\\\\r/g, '\\n')\n  .replace(/^\"+|\"+$/g, '') // remove aspas no início e fim\n  .replace(/\"\\s*\"\\s*/g, '\\n'); // separa blocos entre aspas\n\n// --- Divide em blocos começando por \"LINK\" ---\nfunction dividirPorBlocos(desc) {\n  if (!desc) return [];\n  const linhas = desc.split(/\\r?\\n/).map(l => l.trim()).filter(l => l !== \"\");\n  const blocos = [];\n  let blocoAtual = [];\n\n  for (const linha of linhas) {\n    if (linha.toUpperCase().startsWith(\"LINK\")) {\n      if (blocoAtual.length > 0) {\n        blocos.push(blocoAtual.join(\"\\n\"));\n        blocoAtual = [];\n      }\n    }\n    blocoAtual.push(linha);\n  }\n  if (blocoAtual.length > 0) blocos.push(blocoAtual.join(\"\\n\"));\n  return blocos;\n}\n\n// --- Parseia um bloco em campos estruturados ---\nfunction parsearBloco(bloco) {\n  const info = {};\n  const linhas = bloco.split(\"\\n\").map(l => l.trim());\n\n  for (const linha of linhas) {\n    const L = linha.toUpperCase();\n    if (L.startsWith(\"LINK\")) {\n      const match = linha.match(/LINK\\s+(.+?)\\s*-\\s*(.+)/i);\n      if (match) {\n        info.porta = match[1].trim();\n        info.operadora = match[2].trim();\n      } else {\n        const m2 = linha.match(/LINK\\s+(\\S+)/i);\n        if (m2) info.porta = m2[1].trim();\n      }\n    } else if (L.includes(\"UNIDADE:\")) {\n      info.unidade = linha.split(/UNIDADE:/i)[1].trim();\n    } else if (L.includes(\"ENDEREÇO:\") || L.includes(\"ENDERECO:\")) {\n      info.endereco = linha.split(/ENDEREÇO:|ENDERECO:/i)[1].trim();\n    } else if (L.includes(\"CNPJ:\")) {\n      info.cnpj = linha.split(/CNPJ:/i)[1].trim();\n    } else if (L.includes(\"DESIGNAÇÃO/CIRCUITO:\") || L.includes(\"DESIGNACAO/CIRCUITO:\")) {\n      info.designacao_circuito = linha.split(/DESIGNAÇÃO\\/CIRCUITO:|DESIGNACAO\\/CIRCUITO:/i)[1].trim();\n    } else if (L.startsWith(\"FW:\")) {\n      info.fw = linha.split(/FW:/i)[1].trim();\n    } else if (L.startsWith(\"IP:\")) {\n      info.ip = linha.split(/IP:/i)[1].trim();\n    } else if (L.includes(\"GEOP:\")) {\n      info.geop = linha.split(/GEOP:/i)[1].trim();\n    } else if (L.includes(\"TELEFONE UNIDADE:\") || L.includes(\"TELEFONE:\")) {\n      // captura tudo após o prefixo, mesmo se tiver \"-\"\n      info.telefone_unidade = linha.split(/TELEFONE UNIDADE:|TELEFONE:/i)[1].trim();\n    }\n  }\n\n  return info;\n}\n\n// --- Executa parsing e corrige unidade inválida ---\nconst blocosTexto = dividirPorBlocos(description);\nconst blocos = blocosTexto.map(parsearBloco).map(info => {\n  if (!info.unidade || [\"NAN\", \"NA\", \"N/A\", \"-\"].includes(info.unidade.trim().toUpperCase())) {\n    const partesHost = nomeHostCompleto.split(\" - \");\n    if (partesHost.length > 1) {\n      const unidadePossivel = partesHost[1].replace(/LINK.+/i, \"\").trim();\n      info.unidade = unidadePossivel || nomeLimpoHost;\n    } else {\n      info.unidade = nomeLimpoHost;\n    }\n  }\n  return info;\n});\n\nconst tagsFiltradas = Array();\nfor (const tag of tags) {\n  if (tag.tag.toLowerCase() == 'aplicacao' || tag.tag.toLowerCase() == 'noc') {\n    tagsFiltradas.push(tag)\n  }\n}\n\n\n\n// --- Retorno final ---\nreturn [\n  {\n    json: {\n      idEvento,\n      idHost,\n      nomeHostCompleto,\n      nomeEvento,\n      timestampQueda,\n      dataHoraQuedaFormatado,\n      nomeLimpoHost,\n      statusAlerta,\n      idEventoRecovery,\n      timestampRecovery,\n      dataHoraRecoveryFormatada,\n      blocos,\n      tagsFiltradas\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2688,-144],"id":"210fa9a5-754b-4203-af01-dc892ecc89d9","name":"Ajusta as informações do evento1","retryOnFail":false,"disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"host.get\",\n  \"params\": {\n    \"output\": [\"hostid\", \"name\"],\n    \"selectGroups\": [\"groupid\", \"name\"],\n    \"hostids\": \"{{ $('Normaliza os dados').item.json['id do host'] }}\"\n  },\n  \"auth\": \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  \"id\": 2\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1952,-176],"id":"279bdf27-4266-4d5f-8a6c-cbb59689aea1","name":"Zabbix: Consulta grupo do host","retryOnFail":true,"disabled":true},{"parameters":{"operation":"get","tableId":"base","filters":{"conditions":[{"keyName":"id_evento","keyValue":"={{ $json[\"id do evento\"] }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1376,320],"id":"8b7a8b60-a8cc-4d94-b26f-9bd223071e24","name":"Supabase: Recupera correspondência","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d776d7a-04d8-4a32-aeb0-56e51ec129ef","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1584,320],"id":"8da17d75-2806-4170-92e0-92be0e362bc5","name":"Existe evento no BD?"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1840,448],"id":"916c6c8a-f3c9-4fc5-a92e-52ceacb471ca","name":"No Ops"},{"parameters":{"jsCode":"const hostCompleto = $input.first().json.nome_host;\n\n// --- 1. Extrair somente a primeira parte antes do \" - \" ---\nlet nomeHostBase = hostCompleto.split(\" - \")[0].trim();\n\n// --- 2. Lógica para mapear nomes especiais ---\nlet nomePesquisaDeVariaveis = null;\nconst nomesMapeados = [\"INDIGO\", \"ALL4LABELS\"];\n\n// Verifica se o nomeHostBase contém algum dos nomes mapeados\nfor (const nome of nomesMapeados) {\n  if (nomeHostBase.toUpperCase().includes(nome)) {\n    nomePesquisaDeVariaveis = nome;\n    break;\n  }\n}\n\n// Se não encontrou nenhum nome mapeado, usa o próprio nomeHostBase\nif (!nomePesquisaDeVariaveis) {\n  nomePesquisaDeVariaveis = nomeHostBase;\n}\n\nreturn { nomePesquisaDeVariaveis };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1840,208],"id":"2e8e41bc-ef60-4ca8-ad60-37de0f3048e2","name":"Separa o trecho principal do host"},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"11ynejkll5Q6J6AJ--R3sIxLMyyd3AbTaTS9ncm1KQMs","mode":"list","cachedResultName":"Dados_automação ","cachedResultUrl":"https://docs.google.com/spreadsheets/d/11ynejkll5Q6J6AJ--R3sIxLMyyd3AbTaTS9ncm1KQMs/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":195655548,"mode":"list","cachedResultName":"Contatos_n8n","cachedResultUrl":"https://docs.google.com/spreadsheets/d/11ynejkll5Q6J6AJ--R3sIxLMyyd3AbTaTS9ncm1KQMs/edit#gid=195655548"},"filtersUI":{"values":[{"lookupColumn":"EMPRESA","lookupValue":"={{ $json.nomePesquisaDeVariaveis }}"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2048,208],"id":"b142f456-5d84-4726-aec4-db82130778b1","name":"Sheet: Pesquisa variáveis do cliente","alwaysOutputData":true,"credentials":{"googleApi":{"id":"G23Xn5Fl7KzKph4r","name":"Google Service Account account"}}},{"parameters":{"operation":"get","tableId":"variaveis_cliente","filters":{"conditions":[{"keyName":"nome_variavel","keyValue":"={{ $json[\"RELAÇÃO\"] }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2256,208],"id":"7bdd417b-1d80-4318-b367-94e342c8016f","name":"Supabase: Recupera tipoCliente","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.id }}","rightValue":1,"operator":{"type":"number","operation":"equals"},"id":"1a2fb722-52af-41fe-bf11-ae4a2d231355"}],"combinator":"and"},"renameOutput":true,"outputKey":"CONTRATO 1"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d7e18f65-054c-4518-9581-70d6d3e9f4c4","leftValue":"={{ $json.id }}","rightValue":2,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"CONTRATO 2"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2464491c-9a06-4c1e-9f67-db7551a61253","leftValue":"={{ $json.id }}","rightValue":3,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ALERTAS GERAIS"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[2464,192],"id":"f7485b1e-b806-485c-913a-87d54999a1a9","name":"Rota tipoChamado"}],"connections":{"Prepara os dados para vários eventos":{"main":[[{"node":"Existem dois eventos ou mais?","type":"main","index":0}]]},"Existem dois eventos ou mais?":{"main":[[{"node":"Zabbix: Consulta dados de n eventos","type":"main","index":0}],[{"node":"Supabase: Atualiza encerramento do evento","type":"main","index":0}]]},"Ajusta informação de encerramento para n eventos":{"main":[[{"node":"Movidesk: Notifica encerramento","type":"main","index":0}]]},"Zabbix: Consulta dados de n eventos":{"main":[[{"node":"Organiza os dados em arrays","type":"main","index":0}]]},"Zabbix: Recupera o clock dos eventos":{"main":[[{"node":"Ajusta informação de encerramento para n eventos","type":"main","index":0}]]},"Movidesk: Notifica encerramento":{"main":[[{"node":"Aguarda","type":"main","index":0}]]},"Movidesk: Encerra ticket no Movidesk":{"main":[[{"node":"Notifica encerramento","type":"main","index":0}]]},"Supabase: Atualiza timestamp de recuperação":{"main":[[{"node":"Prepara os dados para vários eventos","type":"main","index":0}]]},"Supabase: Atualiza encerramento do evento":{"main":[[{"node":"Movidesk: Notifica encerramento","type":"main","index":0}]]},"Aguarda":{"main":[[{"node":"Prepara dados para encerramento ","type":"main","index":0}]]},"Prepara dados para encerramento ":{"main":[[{"node":"Movidesk: Encerra ticket no Movidesk","type":"main","index":0}]]},"Consulta dados do evento no Zabbix":{"main":[[{"node":"Ajusta as informações do evento","type":"main","index":0}]]},"Prepara dados para abertura de chamado1":{"main":[[{"node":"Movidesk: Notifica indisponibilidade1","type":"main","index":0}]]},"Organiza os dados em arrays":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Array de rEvents","type":"main","index":0}],[{"node":"Zabbix: Recupera o clock dos eventos","type":"main","index":0}]]},"Ajusta as informações do evento":{"main":[[{"node":"Separa o trecho principal do nomeHost","type":"main","index":0}]]},"Separa o trecho principal do nomeHost":{"main":[[{"node":"Supabase: Nova linha do chamado2","type":"main","index":0}]]},"Supabase: Nova linha do chamado2":{"main":[[{"node":"Prepara dados para abertura de chamado1","type":"main","index":0}]]},"Array de rEvents":{"main":[[{"node":"Consulta dados do evento no Zabbix","type":"main","index":0}]]},"Zabbix: Recupera clock do idRecovery":{"main":[[{"node":"Ajusta data/hora Queda","type":"main","index":0}]]},"Quando executado o main":{"main":[[{"node":"Supabase: Recupera correspondência","type":"main","index":0}]]},"Supabase: Recupera correspondência":{"main":[[{"node":"Existe evento no BD?","type":"main","index":0}]]},"Existe evento no BD?":{"main":[[{"node":"Separa o trecho principal do host","type":"main","index":0}],[{"node":"No Ops","type":"main","index":0}]]},"Separa o trecho principal do host":{"main":[[{"node":"Sheet: Pesquisa variáveis do cliente","type":"main","index":0}]]},"Sheet: Pesquisa variáveis do cliente":{"main":[[{"node":"Supabase: Recupera tipoCliente","type":"main","index":0}]]},"Supabase: Recupera tipoCliente":{"main":[[{"node":"Rota tipoChamado","type":"main","index":0}]]},"Rota tipoChamado":{"main":[[],[],[{"node":"Supabase: Atualiza timestamp de recuperação","type":"main","index":0}]]}},"authors":"system migration","name":null,"description":null,"autosaved":false},"tags":[{"updatedAt":"2025-10-24T18:08:59.444Z","createdAt":"2025-10-24T18:08:59.444Z","id":"jng5bBYYvxUL3PF4","name":"fluxoEncerramento"},{"updatedAt":"2025-10-24T18:08:27.659Z","createdAt":"2025-10-24T18:08:27.659Z","id":"oUDNU2rUDi9xwp5Q","name":"FluxoNOC_principal"}]}