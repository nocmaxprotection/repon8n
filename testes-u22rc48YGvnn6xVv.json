{"updatedAt":"2026-01-29T17:15:16.886Z","createdAt":"2025-10-20T20:38:12.791Z","id":"u22rc48YGvnn6xVv","name":"Testes","active":false,"isArchived":false,"nodes":[{"parameters":{"operation":"getAll","tableId":"eventosZabbix","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"raizNomeHost","condition":"eq","keyValue":"={{ $('Ajusta a raizNomeHost').item.json.raiz_nome_completo }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1920,6176],"id":"f471b920-3c9f-4c2b-935f-de39b2d5daf7","name":"BD: Procura eventos do grupo","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9b0785e1-5b00-41f1-9e5d-be72f6afebd9","leftValue":"","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2144,6176],"id":"20970ffd-d390-4059-b0a5-bcbbc5c7485e","name":"Existe eventos?","disabled":true},{"parameters":{"jsCode":"// verifica em eventos relacionados se o eventId do evento do fluxo está inserido nos dados\n  // se true\n    // separa em 2 grupos (resolvidos e não resolvidos)\n    // se 2 grupos\n      // emite tagGrupos = true\n      // emite dados do grupo\n    // se 1 grupo\n      // emite tagGrupos = false\n      // emite dados do grupo\n  // se false\n    // o evento possui acknowledges\n      // se true\n        // emite tagAck = true\n        // adiciona o evento no bd com status 3\n        // === finaliza ===\n      // se false\n        // emite tagAck = false\n        // === finaliza ==="},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2368,5984],"id":"ddeddf3b-4e64-43ba-8539-acd18116e977","name":"Verifica eventid resolvidos","disabled":true},{"parameters":{"mode":"expression","numberOutputs":2,"output":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[2592,5984],"id":"1d663dee-0fde-4cba-8cbe-10fb0d768225","name":"Switch","disabled":true},{"parameters":{"operation":"update"},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2816,5888],"id":"362d001e-4055-4bc4-911f-80e1b1714081","name":"BD: Atualiza dados de encerramento","credentials":{"supabaseApi":{"id":"p9a9JH9aNSyBZyub","name":"Supabase account 2"}},"disabled":true},{"parameters":{"jsCode":"// verificar se tem reconhecimentos com ticket movidesk\n  // se true\n    // emite tagReconhecidos = true\n  // se false\n    // emite tagReconhecidos = false"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2816,6080],"id":"696e841c-c9c7-431c-b9c1-8a3f1681a2f6","name":"Verifica ack6 com ticketMovidesk","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d5ef9ad2-d5c0-4524-9d1c-a2c5526e482c","leftValue":"","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3040,6080],"id":"f8e10d04-58fd-4923-9049-49986243d9ea","name":"If1","disabled":true},{"parameters":{"operation":"update"},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3264,5984],"id":"27a34a85-7bce-4e70-ad1d-968a447eaf45","name":"BD: Atualiza dados de encerramento1","credentials":{"supabaseApi":{"id":"p9a9JH9aNSyBZyub","name":"Supabase account 2"}},"disabled":true},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[3264,6176],"id":"cbefc113-abee-4547-be95-ccb8dbb0cbad","name":"Do not1","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ab152287-740a-4e0e-b762-2da492de6b83","leftValue":"","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2368,6272],"id":"6365a972-50a6-49d0-88e4-175d9c9c41e5","name":"Tem acknowledge?","disabled":true},{"parameters":{"operation":"update"},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2592,6176],"id":"a097f362-c091-4ceb-994a-8a12b41d810a","name":"BD: Atualiza dados de encerramento2","credentials":{"supabaseApi":{"id":"p9a9JH9aNSyBZyub","name":"Supabase account 2"}},"disabled":true},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2592,6368],"id":"a8c35639-2a43-42d7-b2b2-6e5ef74cfeff","name":"Do not2","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"731a26c5-b3b3-4b92-a121-61289d0e4f7d","leftValue":"={{ $('Ajusta dados do evento').item.json.reconhecimento }}","rightValue":"Reconhecido","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1904,6896],"id":"19663459-2931-4044-b532-e6b1f759762d","name":"Evento reconhecido?","disabled":true},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2128,6992],"id":"8443cec8-ab2f-4a87-8f42-e019d5b832dd","name":"Do not5","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6b42b757-ffcc-46a9-b490-ca33ee45f54b","leftValue":"={{ $json.matchTicket }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2800,6704],"id":"51fd1b19-7e6d-43de-988f-c60ec16e58ba","name":"Ticket válido?","disabled":true},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[3024,6800],"id":"f6287ca6-3227-4264-be72-1fbe0f1e7ac7","name":"Do not6","disabled":true},{"parameters":{"jsCode":"const idCliente = $('Google: Select variáveis cliente').first().json.ID_MOVIDESK;\nconst copiaPara = $('Google: Select variáveis cliente').first().json.CC;\n\n// ==== RETORNA GREETING CONFORME TURNO ====\nfunction getGreeting() {\n\tconst horaInicioNoite = 18;\n\tconst horaFinalNoite = 5;\n\tconst horaInicialDia = 5;\n\tconst horaFinalDia = 12;\n\n\t// CORREÇÃO: obter hora corretamente no fuso São Paulo\n\tconst horaLocal = DateTime.now().setZone(\"America/Sao_Paulo\").hour;\n\n\tlet greeting;\n\n\tif (horaLocal >= horaInicioNoite || horaLocal < horaFinalNoite) {\n\t\tgreeting = \"Boa noite\";\n\t} else if (horaLocal >= horaInicialDia && horaLocal < horaFinalDia) {\n\t\tgreeting = \"Bom dia\";\n\t} else {\n\t\tgreeting = \"Boa tarde\";\n\t}\n\n\treturn greeting;\n}\n\n// Monta as linhas do tbody\nconst hostName = $('Ajusta dados do evento').first().json.nome_host;\nconst raizNomeHost = hostName.split(\"-\")[0].trim();\nconst evento = $('Ajusta dados do evento').first().json.nome_trigger;\nconst data_hora_queda = $('Ajusta dados do evento').first().json.data_hora_evento;\nconst data_hora_recuperacao = $('Ajusta dados do evento').first().json.data_hora_recuperacao;\n\n// ==== CLIAR HTML DO CLIENTE ====\nfunction htmlCliente(nomeHost, eventoGerador, dataHoraEvento, dataHoraEncerramento){\n  const htmlCliente = `\n    <p>${getGreeting()}</p>\n    <br>\n    <p>O seguinte evento consta resolvido em nosso sistema de monitoramento:</p>\n    <div style=\"width: 95%; padding: 10px; margin:10px 0; text-align: center; align-items: center;\">\n      <table border=\"1\" cellspacing=\"0\" cellpadding=\"5\" style=\"width:100%\">\n        <thead>\n            <tr>\n              <th>Host</th>\n              <th>Evento</th>\n              <th>Horário da queda</th>\n              <th>Horário de recuperação do evento</th>\n            </tr>\n        </thead>\n        <tbody>\n            <tr>\n              <td>${nomeHost}</td>\n              <td>${eventoGerador}</td>\n              <td>${dataHoraEvento}</td>\n              <td>${dataHoraEncerramento}</td>\n            </tr>\n        </tbody>\n      </table>\n    </div>\n    \n    <p> Permaneceremos à disposição.</p>\n    <br>\n    <br>\n    <p>Atenciosamente </p>\n    <img src=\"https://s3.amazonaws.com/movidesk-files/F63A932F58073D98A6D18347DEE480C5?AWSAccessKeyId=AKIAWSRCTWGBHCVKCQGD&Expires=1762462132&Signature=q%2FTkmFvX5ZyV4Id96xCPLnHgNzs%3D\">\n  `;\n  return htmlCliente;\n}\n\n\nreturn [{\n  htmlCliente: htmlCliente(hostName, evento, data_hora_queda, data_hora_recuperacao),\n  idCliente,\n  copiaPara\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3472,6608],"id":"523a673f-6f54-447c-b69e-6d1d2ffa33f8","name":"Prepara html do cliente1","disabled":true},{"parameters":{"jsCode":"const htmlCliente = $input.first().json.htmlCliente;\n\n//id_movideks_para_testes = 1836303904\n\n// ==== RETORNO QUE SERÁ USADO PELO HTTPREQUEST NO PRÓXIMO NÓ ====\nreturn {\n  json: {\n    actions: [\n      { type: 2, description: htmlCliente ,createdBy: { id: \"1458772347\" }, workTime: \"00:02:00\" }\n    ]\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3696,6608],"id":"c9e75978-7f88-41a1-9a96-a14d11d2e0da","name":"json para atualizar ticket Movidesk1","disabled":true},{"parameters":{"method":"PATCH","url":"=https://atendimento.maxprotection.com.br/public/v1/tickets?token=538206c9-60b4-4bf4-ae85-415ab9a68be6&id={{ $('BD: Select linha existente').item.json.ticketMovidesk }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3920,6608],"id":"12db66b0-f939-4a50-be5e-232d4e9111bd","name":"Movidesk: Update evento1","retryOnFail":true,"disabled":true},{"parameters":{},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[4144,6608],"id":"3dd6ebb9-844c-426c-ba63-9642755da137","name":"BD: Add nova linha no bd","credentials":{"supabaseApi":{"id":"p9a9JH9aNSyBZyub","name":"Supabase account 2"}},"disabled":true},{"parameters":{"authentication":"webhook","content":"=","options":{},"embeds":{"values":[{"description":"=*O seguinte evento consta como resolvido no Zabbix*\n\n**CLIENTE:** {{ $json.raizNomeHost }}\n**HOST MATRIZ:** {{ $json.nomeHost }}\n**EVENTO:** {{ $json.nomeEvento }}\n**DATA E HORA DA QUEDA:** {{ $('Ajusta dados do evento').first().json.data_hora_evento }}\n**DATA E HORA DO RESTABELECIMENTO:** {{ $('Ajusta dados do evento').first().json.data_hora_recuperacao }}\n**TICKET MOVIDESK:** {{ $json.ticketMovidesk }}","color":"#69BF6C","title":"EVENTO RESOLVIDO","thumbnail":"https://cdn-icons-png.freepik.com/512/16799/16799619.png"}]}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[4368,6608],"id":"255df8f6-9f86-4ce0-a725-9ce1a573aabc","name":"Discord: Notifica evento resolvido1","webhookId":"5602e92a-bce3-4895-9977-2ff14b2bfc30","retryOnFail":true,"credentials":{"discordWebhookApi":{"id":"lA2qaXo0Uc6Pobsl","name":"Canal: encerramento de chamado"}},"disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2352,6800],"id":"09a9d2c2-ae23-4067-817e-2476361f5ac5","name":"Zabbix: Consulta evento2","retryOnFail":true,"disabled":true,"onError":"continueErrorOutput"},{"parameters":{"jsCode":"const id_evento = $('Ajusta dados do evento').first().json.ID_evento;\nconst authenticator = $('Ajusta dados do evento').first().json.ID_consulta_zabbix;\n\nreturn {\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"event.get\",\n  \"params\": {\n    \"output\": [\"eventid\", \"clock\", \"r_eventid\", \"acknowledged\"],\n\n    \"eventids\": [`${id_evento}`],\n\n    \"selectAcknowledges\": [\"message\", \"action\"]\n\n  },\n  \"auth\": authenticator,\n  \"id\": 1\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2128,6800],"id":"3d20e6f9-ecec-452d-9946-c6bbbde5bf8a","name":"Prepara json para consulta de evento","disabled":true},{"parameters":{"authentication":"webhook","content":"=","options":{},"embeds":{"values":[{"description":"=Verificar o fluxo principal. Houve um problema na consulta de dados no Zabbix na rota de encerramento para contratos 2.","color":"#009EDD","title":"=PROBLEMA NO FLUXO PRINCIPAL","thumbnail":"https://cdn-icons-png.freepik.com/512/6897/6897039.png"}]}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[2576,6896],"id":"9839a53f-5e6f-42f4-8dad-97b6fab1970b","name":"Discord: Problema no BD5","webhookId":"5602e92a-bce3-4895-9977-2ff14b2bfc30","retryOnFail":true,"credentials":{"discordWebhookApi":{"id":"pD90IU7lYfcf9FwM","name":"Canal: administrativo"}},"disabled":true},{"parameters":{"url":"=https://atendimento.maxprotection.com.br/public/v1/tickets?token=538206c9-60b4-4bf4-ae85-415ab9a68be6&id={{ $json.mensagem_para_acks }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3024,6608],"id":"58239243-6a43-4bde-aa0c-00bc5e3fd7f0","name":"Movidesk: Consulta de informações do ticket","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"534bf1cc-880d-433f-b4fc-753ff1627ecb","leftValue":"={{ $json.status }}","rightValue":"Resolvido","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3248,6608],"id":"0805899d-f5f9-4bf7-970c-a1e32a55b994","name":"Ticket aberto?","disabled":true},{"parameters":{"jsCode":"const reconhecimentos = $input.first().json.result[0].acknowledges || [];\n\n// Filtra apenas reconhecimentos com action == '6'\nconst eventos_com_ack_seis = reconhecimentos.filter(r => r.action == '6');\n\nlet mensagem_para_acks = null;\nlet matchTicket = false;\n\nif (eventos_com_ack_seis.length === 1) {\n  const mensagem = eventos_com_ack_seis[0].message?.trim();\n\n  // Verifica se a mensagem contém um número (ex: ID do ticket Movidesk)\n  const numeroEncontrado = mensagem && mensagem.match(/\\b\\d+\\b/); // encontra número isolado\n\n  if (numeroEncontrado) {\n    const ticket = parseInt(numeroEncontrado[0], 10);\n\n    if (!isNaN(ticket)) {\n      mensagem_para_acks = ticket;\n      matchTicket = true;\n    }\n  }\n}\n\n// Retorna sempre algo, com a flag indicando se houve match\nreturn [{\n  mensagem_para_acks,\n  matchTicket\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2576,6704],"id":"7d93769c-c948-4b31-b6d5-4da8b7776408","name":"Trata do ticket","disabled":true},{"parameters":{"content":"EVENTOS DE ENCERRAMENTO CONTRATOS 2\n","height":608,"width":2752},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1856,6560],"id":"bad2aa8f-c3da-4999-8cce-4eb23d3d4470","name":"Sticky Note"},{"parameters":{"content":"EVENTOS DE ENCERRAMENTO CONTRATOS 1\n","height":640,"width":1616},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1856,5872],"id":"3fbe446e-5f54-4c7b-a444-abf152b9ef91","name":"Sticky Note1"}],"connections":{"BD: Procura eventos do grupo":{"main":[[{"node":"Existe eventos?","type":"main","index":0}]]},"Existe eventos?":{"main":[[{"node":"Verifica eventid resolvidos","type":"main","index":0}],[{"node":"Tem acknowledge?","type":"main","index":0}]]},"Verifica eventid resolvidos":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Switch":{"main":[[{"node":"BD: Atualiza dados de encerramento","type":"main","index":0}],[{"node":"Verifica ack6 com ticketMovidesk","type":"main","index":0}]]},"Verifica ack6 com ticketMovidesk":{"main":[[{"node":"If1","type":"main","index":0}]]},"If1":{"main":[[{"node":"BD: Atualiza dados de encerramento1","type":"main","index":0}],[{"node":"Do not1","type":"main","index":0}]]},"Tem acknowledge?":{"main":[[{"node":"BD: Atualiza dados de encerramento2","type":"main","index":0}],[{"node":"Do not2","type":"main","index":0}]]},"Evento reconhecido?":{"main":[[{"node":"Prepara json para consulta de evento","type":"main","index":0}],[{"node":"Do not5","type":"main","index":0}]]},"Ticket válido?":{"main":[[{"node":"Movidesk: Consulta de informações do ticket","type":"main","index":0}],[{"node":"Do not6","type":"main","index":0}]]},"Prepara html do cliente1":{"main":[[{"node":"json para atualizar ticket Movidesk1","type":"main","index":0}]]},"json para atualizar ticket Movidesk1":{"main":[[{"node":"Movidesk: Update evento1","type":"main","index":0}]]},"Movidesk: Update evento1":{"main":[[{"node":"BD: Add nova linha no bd","type":"main","index":0}]]},"BD: Add nova linha no bd":{"main":[[{"node":"Discord: Notifica evento resolvido1","type":"main","index":0}]]},"Zabbix: Consulta evento2":{"main":[[{"node":"Trata do ticket","type":"main","index":0}],[{"node":"Discord: Problema no BD5","type":"main","index":0}]]},"Prepara json para consulta de evento":{"main":[[{"node":"Zabbix: Consulta evento2","type":"main","index":0}]]},"Movidesk: Consulta de informações do ticket":{"main":[[{"node":"Ticket aberto?","type":"main","index":0}]]},"Ticket aberto?":{"main":[[{"node":"Prepara html do cliente1","type":"main","index":0}]]},"Trata do ticket":{"main":[[{"node":"Ticket válido?","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"903f3662-133f-4d5c-bac3-91fb592428b5","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-10-20T20:38:12.800Z","createdAt":"2025-10-20T20:38:12.800Z","role":"workflow:owner","workflowId":"u22rc48YGvnn6xVv","projectId":"UcF1WBdewsFeRVFr"}],"activeVersion":null,"tags":[{"updatedAt":"2025-10-24T20:38:56.289Z","createdAt":"2025-10-24T20:38:56.289Z","id":"fb4uRBa519tsrAKx","name":"teste"}]}