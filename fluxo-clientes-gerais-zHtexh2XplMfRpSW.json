{"updatedAt":"2025-11-06T18:13:55.000Z","createdAt":"2025-11-04T16:50:19.688Z","id":"zHtexh2XplMfRpSW","name":"Fluxo clientes gerais","active":true,"isArchived":true,"nodes":[{"parameters":{"jsCode":"const timestampQuedaLink = $input.first().json.clock;\nconst segundosTempoAtras = $input.first().json.segundosVariavelCliente;\n\nconst timestampMenosTempoAtras = timestampQuedaLink - segundosTempoAtras;\n\nreturn {\n  \"timestampQueda\": timestampQuedaLink,\n  \"timestampQueda_formatada\": DateTime.fromSeconds(timestampQuedaLink).setZone('America/Sao_Paulo').toFormat('dd/MM/yyyy HH:mm:ss'),\n  \"timestamp_queda_decrescido_tempo_cliente\": timestampMenosTempoAtras,\n  \"timestamp_queda_decrescido_tempo_cliente_formatado\": DateTime.fromSeconds(timestampMenosTempoAtras).setZone('America/Sao_Paulo').toFormat('dd/MM/yyyy HH:mm:ss')\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[960,-288],"id":"04632aa8-5b4a-4e4f-98bd-0311ba0ab171","name":"Subtrai tempo vari√°vel cliente do tempo atual"},{"parameters":{"jsCode":"const idEventoTabela = $input.first().json.id;\nconst ticketMovideskTabela = $input.first().json.ticket_movidesk;\n\nif ((idEventoTabela && ticketMovideskTabela) || (idEventoTabela && ticketMovideskTabela == 0) ) {\n  return { \n    \"linha_tabela\": \"Rota1 - ticketTabela\",\n    \"descricao\": \"Com evento e ticket na tabela\"\n  }\n} else if (!idEventoTabela && !ticketMovideskTabela) {\n  return {\n    \"linha_tabela\": \"Rota 3 - verificarZabbix\",\n    \"descricao\": \"Sem evento na tabela\"\n  }\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1408,-288],"id":"e52a25d3-5e03-463f-80ea-820ab23f9bf0","name":"Valida se existe ticket e direciona"},{"parameters":{"jsCode":"// Filtra apenas eventos com algum acknowledge de action == \"6\"\nconst eventos = $input.first().json.result;\n\n// Filtra apenas eventos que t√™m pelo menos um ack com action == \"6\"\nconst filtrados = eventos\n  .filter(ev => ev.acknowledges?.some(ack => ack.action == 6))\n  .map(ev => {\n    // Dentro de cada evento, pega s√≥ os acks com action == 6\n    const acks6 = (ev.acknowledges || []).filter(ack => ack.action == 6);\n\n    // Ordena por acknowledgeid (num√©rico) e pega o maior\n    const ackMaior = [...acks6].sort((a, b) => Number(b.acknowledgeid) - Number(a.acknowledgeid))[0];\n\n    // Retorna o evento com destaque para o acknowledge mais recente\n    return {\n      json: {\n        eventid: ev.eventid,\n        clock: ev.clock,\n        hostid: ev.hosts?.[0]?.hostid,\n        host: ev.hosts?.[0]?.host,\n        value: ev.value,\n        // acknowledge de maior id\n        acknowledge_mais_recente: {\n          acknowledgeid: ackMaior.acknowledgeid,\n          clock: ackMaior.clock,\n          \"timestampAck_formatado\": DateTime.fromSeconds(parseInt(ackMaior.clock))\n            .setZone('America/Sao_Paulo')\n            .toFormat('dd/MM/yyyy HH:mm:ss'),\n          message: ackMaior.message,\n          action: ackMaior.action,\n          username: ackMaior.username,\n          userid: ackMaior.userid\n        }\n      }\n    };\n  });\n\n// Retorna cada evento filtrado como item independente\nif (filtrados.length === 0) {\n  return {\n    json: {\n      \"acksFiltrados\": {\n        filtrados, \n        \"status\": false\n      }\n    }\n  }\n} else {\n  return {\n    json: {\n      \"acksFiltrados\": {\n        filtrados, \n        \"status\": true\n      }\n    }\n  }\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2080,0],"id":"ff5042f8-4bfa-46b6-a497-cd3408cdd8dd","name":"Separa alertas com acks === 6"},{"parameters":{"url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"event.get\",\n  \"params\": {\n    \"output\": [\"eventid\", \"clock\", \"name\", \"value\", \"host\", \"hostid\"],\n    \"select_acknowledges\": [\n      \"acknowledgeid\",\n      \"userid\",\n      \"eventid\",\n      \"clock\",\n      \"message\",\n      \"action\",\n      \"username\"\n    ],\n    \"time_from\": \"{{ $('Subtrai tempo vari√°vel cliente do tempo atual').item.json.timestamp_queda_decrescido_tempo_cliente }}\",\n    \"selectHosts\": [\"hostid\", \"host\"],\n    \"hostids\": \"{{ $('Prepara os dados1').item.json.hostId }}\",\n    \"sortfield\": \"clock\",\n    \"sortorder\": \"DESC\"\n  },\n  \"auth\": \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  \"id\": 1\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1856,0],"id":"c91e9e5b-da29-493f-8e5f-c192cd964088","name":"Consulta por eventos anteriores","alwaysOutputData":false,"retryOnFail":true,"notesInFlow":false},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"cb6eff08-3023-4783-bfaf-1cacf44c64ab","leftValue":"={{ $json.acksFiltrados.status }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2304,0],"id":"186bdf27-98f7-480c-894f-132c73f62b1c","name":"Se vazio, ent√£o abrir chamado"},{"parameters":{"jsCode":"// Obt√©m a mensagem\nlet messageTicket = $input.first().json.acksFiltrados.filtrados[0].json.acknowledge_mais_recente.message;\n\nlet numeroTicket;\n\n// Tenta encontrar n√∫meros na mensagem\nlet numerosEncontrados = messageTicket.match(/\\d+/);\n\nif (numerosEncontrados && numerosEncontrados.length > 0) {\n    numeroTicket = parseInt(numerosEncontrados[0]);\n} else {\n    // Se n√£o encontrar n√∫meros, retorna o texto completo\n    numeroTicket = messageTicket;\n}\n\n// Verifica se o valor √© uma string (n√£o num√©rica)\nif (typeof(numeroTicket) === \"string\") {\n  return [\n    { \n      ticket: 0,\n      message: messageTicket\n    }\n  ];\n} else {\n  return [\n    { \n      ticketMovidesk: numeroTicket,\n      message: messageTicket\n    }\n  ];\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2528,96],"id":"3de62352-0fc9-491a-a5d8-08b9e131f4be","name":"Prepara dados para ack"},{"parameters":{"tableId":"base"},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2976,-48],"id":"6576f3dc-a96b-42bd-bd0f-c82138d26116","name":"Adiciona nova linha na tabela","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}}},{"parameters":{"tableId":"base","fieldsUi":{"fieldValues":[{"fieldId":"id_host","fieldValue":"={{ parseInt($('Prepara os dados').item.json.hostId) }}"},{"fieldId":"ticket_movidesk","fieldValue":"={{ parseInt($json.message) }}"},{"fieldId":"timestamp_queda","fieldValue":"={{ parseInt($('Prepara os dados').item.json.clock) }}"},{"fieldId":"id_cliente_variaveis","fieldValue":"3"},{"fieldId":"status_chamado","fieldValue":"2"},{"fieldId":"id_evento","fieldValue":"={{ parseInt($('Prepara os dados').item.json.idEvento) }}"},{"fieldId":"evento_raiz","fieldValue":"={{ parseInt($('Prepara os dados').item.json.idEvento) }}"},{"fieldId":"nome_host","fieldValue":"={{ $('Prepara os dados').item.json.nomeHost }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2976,240],"id":"68df18f1-cc02-4d3e-a868-6e4cefb7e60a","name":"Adiciona nova linha na tabela1","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}}},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","authentication":"predefinedCredentialType","nodeCredentialType":"zabbixApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3424,96],"id":"52892d43-3ffc-43df-8de3-b532378be74e","name":"Atualiza evento Zabbix","alwaysOutputData":false,"retryOnFail":true,"notesInFlow":false,"credentials":{"zabbixApi":{"id":"zl1coyXkQaqMlor1","name":"Zabbix"}},"disabled":true},{"parameters":{"jsCode":"const messageAcks = $('Separa alertas com acks === 6').first().json.acksFiltrados.filtrados[0].json.acknowledge_mais_recente.message;\nconst eventId = $input.first().json.id_evento;\n\n\nreturn {\n  jsonrpc: \"2.0\",\n  method: \"event.acknowledge\",\n  params: {\n    eventids: eventId,\n    message: String(messageAcks),\n    action: 6\n  },\n  auth: \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  id: 1\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3200,-48],"id":"32f5c98b-c80e-4f04-bf86-dcd695d348bc","name":"Prepara para update mensagem correta1","disabled":true},{"parameters":{"jsCode":"const messageAcks = $input.first().json.ticket_movidesk;\nconst eventId = $('Prepara os dados').first().json.idEvento;\n\nreturn {\n  jsonrpc: \"2.0\",\n  method: \"event.acknowledge\",\n  params: {\n    eventids: eventId,\n    message: String(messageAcks),\n    action: 6\n  },\n  auth: \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  id: 1\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3200,240],"id":"d209c0aa-dd88-42b3-acae-7eb6c32c2788","name":"Prepara para update mensagem correta","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b83ec77b-2171-41f1-b0ba-869e5b6233bd","leftValue":"={{ $json.ticketMovidesk }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2752,96],"id":"6e598a7d-627f-4646-be52-f42dddc739f9","name":"Valida se existe ticket Movidesk"},{"parameters":{"authentication":"webhook","options":{},"embeds":{"values":[{"description":"=*Nota: o evento foi atualizado com o √∫timo ticket registrado no Zabbix porque ainda est√° dentro do per√≠odo de valida√ß√£o de restabelecimento*\n\nüñ•Ô∏è **Host:** {{ $('Prepara os dados').item.json.nomeHost }}\nüìõ **Nome do alerta:** {{ $('Prepara os dados').item.json.nomeEvento }}\nüïí **Data e hora do evento:** {{ $('Subtrai tempo vari√°vel cliente do tempo atual').item.json.timestamp_queda_decrescido_tempo_cliente_formatado }}\nüïí **Data e hora da atualiza√ß√£o:** {{ DateTime.now().format('dd/MM/yyyy HH:mm:ss')}}\nüéüÔ∏è **Ticket Movidesk:** $input.first().json.ticket_movidesk\n\nüìÑ **Linha no BD:** {{ $('Adiciona nova linha na tabela').item.json.sid }}\n\n","color":"#25FF2C","title":"üö® O seguinte evento foi atualizado no Zabbix e na tabela"}]}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[3424,288],"id":"b59c54a6-9510-4f58-92e9-0fb267f2c962","name":"Atualiza a equipe sobre o alerta com ticket","webhookId":"eeed722b-607e-4597-8511-e54a55e53154","retryOnFail":true,"credentials":{"discordWebhookApi":{"id":"cpyl61bJ83gXe4YH","name":"Canal: abertura de chamados e atualiza√ß√µes"}},"disabled":true},{"parameters":{"authentication":"webhook","options":{},"embeds":{"values":[{"description":"=*Nota: o evento foi atualizado com o √∫timo ticket registrado no Zabbix porque ainda est√° dentro do per√≠odo de valida√ß√£o de restabelecimento*\n\nüñ•Ô∏è **Host:** {{ $('Prepara os dados').item.json.nomeHost }}\nüìõ **Nome do alerta:** {{ $('Prepara os dados').item.json.nomeEvento }}\nüïí **Data e hora do evento:** {{ $('Subtrai tempo vari√°vel cliente do tempo atual').item.json.timestamp_queda_decrescido_tempo_cliente_formatado }}\nüïí **Data e hora da atualiza√ß√£o:** {{ DateTime.now().format('dd/MM/yyyy HH:mm:ss')}}\nüéüÔ∏è **Ticket Movidesk:** N√£o criado\n\nüìÑ **Linha no BD:** {{ $('Adiciona nova linha na tabela').item.json.sid }}\n\n","color":"#25FF2C","title":"üö® O seguinte evento foi atualizado no Zabbix e na tabela"}]}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[3424,-96],"id":"f88eca65-5c25-42f9-819a-46238b51e0f9","name":"Atualiza a equipe sobre o alerta sem ticket","webhookId":"eeed722b-607e-4597-8511-e54a55e53154","retryOnFail":true,"credentials":{"discordWebhookApi":{"id":"cpyl61bJ83gXe4YH","name":"Canal: abertura de chamados e atualiza√ß√µes"}},"disabled":true},{"parameters":{"jsCode":"const nomeHost = $('Prepara os dados').first().json.nomeHost;\nconst nomeEvento = $('Prepara os dados').first().json.nomeEvento;\nconst timestampQueda = parseInt($('Prepara os dados').first().json.clock);\nconst dataHoraFormatada = DateTime.fromSeconds(timestampQueda).toFormat('dd/MM/yyyy HH:mm:ss')\nconst nomeHostLimpo = $('Prepara os dados').first().json.nomeHostLimpo;\n\n// ==== EXTRAIR OPERADORA DO NOME DO HOST ====\nfunction extrairOperadoraDoHost(nomeHostCompleto) {\n    if (!nomeHostCompleto) return \"(NOME DA OPERADORA)\";\n    \n    // Divide o nome do host pelos h√≠fens\n    const partes = nomeHostCompleto.split(\" - \");\n    \n    // Se tiver pelo menos 3 partes, pega a segunda parte (√≠ndice 1)\n    if (partes.length >= 3) {\n        return partes[1].trim();\n    }\n    \n    // Se n√£o encontrar o padr√£o esperado, retorna o padr√£o\n    return \"\";\n}\n\nconst nomeLink = extrairOperadoraDoHost(nomeHost);\n\n// ==== VARI√ÅVEIS DO CLIENTE =====\nconst idCliente = \"1836303904\"// $input.first().json.ID ex.: \"1836303904\"; vari√°vel - pesquisar na planilha de dados do cliente\nconst emCopiaPara = \"\"; // 'william.semmler@maxprotection.com.br' + ',' + 'arthur.freschi@maxprotection.com.br' + ',' + 'fernanda.hernandez@maxprotection.com.br'; // vari√°vel - pesquisar na planilha de dados do cliente\n\n// ===== PREPARA√á√ÉO PARA CRIA√á√ÉO DO TICKET ====\nconst htmlCliente = `\n<p>Boa tarde.</p>\n<br>\n<p>Identificamos o seguinte alerta em nosso sistema de monitoramento:</p>\n\n<div style=\"padding: 10px; border: 1px solid black; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; text-align: center; align-items: center; color: black; margin: 10px 0\">\n  <h2>${nomeHost}</h2>\n  <p style=\"font-size: 16px;\"><strong>Evento:</strong> ${nomeEvento}</p>\n  <p style=\"font-size: 16px;\"><strong>Data e hora da queda:</strong> ${dataHoraFormatada}</p>\n</div>\n\n<p> Gostar√≠amos de confirmar se a ocorr√™ncia j√° √© de conhecimento da equipe ${nomeHostLimpo} ou se trata de uma falha eventual? </p>\n<p>Recomendamos a verifica√ß√£o da ocorr√™ncia acima para valida√ß√£o e tratativa da indisponibilidade. Permaneceremos em monitoramento e informaremos quando o evento estiver com status de resolvido em nosso monitoramento.</p>\n`;\n\n// ==== RETORNO QUE SER√Å USADO PELO HTTPREQUEST NO PR√ìXIMO N√ì ====\nreturn {\n  json: {\n    type: 2,\n    subject: `REPARO - ${nomeHostLimpo} - ${nomeLink}`,\n    category: \"01 - Atendimento Helpdesk\",\n    serviceFirstLevelId: 325878,\n    urgency: \"M√©dia\",\n    ownerTeam: \"NOC\",\n    status: \"Aguardando\",\n    justification: \"Valida√ß√£o\",\n    createdBy: { id: \"1458772347\" },\n    Clients: [{ id: idCliente }],\n    cc: emCopiaPara,\n    actions: [\n      { type: 2, description: htmlCliente, createdBy: { id: \"1458772347\" } }\n    ]\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2752,-288],"id":"ecb352b5-213f-4f5c-a1ef-982ec9835593","name":"Prepara dados para abertura de chamado no Movidesk","disabled":true},{"parameters":{"tableId":"base","fieldsUi":{"fieldValues":[{"fieldId":"id_host","fieldValue":"={{ parseInt($('Prepara os dados').item.json.hostId) }}"},{"fieldId":"nome_host","fieldValue":"={{ $('Prepara os dados').item.json.nomeHost }}"},{"fieldId":"ticket_movidesk","fieldValue":"={{ $json.id }}"},{"fieldId":"timestamp_queda","fieldValue":"={{ parseInt($('Prepara os dados').item.json.clock) }}"},{"fieldId":"id_cliente_variaveis","fieldValue":"3"},{"fieldId":"status_chamado","fieldValue":"2"},{"fieldId":"id_evento","fieldValue":"={{ parseInt($('Prepara os dados').item.json.idEvento) }}"},{"fieldId":"evento_raiz","fieldValue":"={{ parseInt($('Prepara os dados').item.json.idEvento) }}"},{"fieldId":"hostLimpo","fieldValue":"={{ $('Prepara os dados').item.json.nomeHostLimpo }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3200,-288],"id":"f7213133-7f85-4d57-8030-781a14215d79","name":"Cria linha de chamado aberto","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}},"disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","authentication":"predefinedCredentialType","nodeCredentialType":"zabbixApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3648,-288],"id":"fb9fc168-76b4-42c7-a339-76914f49ea38","name":"Atualiza evento Zabbix1","alwaysOutputData":false,"retryOnFail":true,"notesInFlow":false,"credentials":{"zabbixApi":{"id":"zl1coyXkQaqMlor1","name":"Zabbix"}},"disabled":true},{"parameters":{"jsCode":"const messageAcks = $input.first().json.ticket_movidesk;\nconst eventId = $input.first().json.id_evento;\n\n\nreturn {\n  jsonrpc: \"2.0\",\n  method: \"event.acknowledge\",\n  params: {\n    eventids: eventId,\n    message: String(messageAcks),\n    action: 6\n  },\n  auth: \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  id: 1\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3424,-288],"id":"dcacb891-1c78-463e-a33d-ceb9e7732f11","name":"Prepara para update mensagem correta2","disabled":true},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"11ynejkll5Q6J6AJ--R3sIxLMyyd3AbTaTS9ncm1KQMs","mode":"list","cachedResultName":"Contato empresas","cachedResultUrl":"https://docs.google.com/spreadsheets/d/11ynejkll5Q6J6AJ--R3sIxLMyyd3AbTaTS9ncm1KQMs/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":195655548,"mode":"list","cachedResultName":"Contatos_n8n","cachedResultUrl":"https://docs.google.com/spreadsheets/d/11ynejkll5Q6J6AJ--R3sIxLMyyd3AbTaTS9ncm1KQMs/edit#gid=195655548"},"filtersUI":{"values":[{"lookupColumn":"EMPRESA","lookupValue":"={{ $('Prepara os dados').item.json.nomeHostLimpo }}"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2528,-288],"id":"8d878d66-9b38-4a39-aa81-ac0934145bde","name":"Recupera dados do cliente na planilha","alwaysOutputData":true,"credentials":{"googleApi":{"id":"G23Xn5Fl7KzKph4r","name":"Google Service Account account"}},"disabled":true},{"parameters":{"operation":"getAll","tableId":"base","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"hostLimpo","condition":"eq","keyValue":"={{ $('Prepara os dados1').item.json.nomeHostLimpo }}"},{"keyName":"timestamp_queda","condition":"gte","keyValue":"={{ $json.timestamp_queda_decrescido_tempo_cliente }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1184,-288],"id":"d3ea3222-8a0c-48fe-91e3-4a5f132534b6","name":"Recupera as linhas correspondentes","alwaysOutputData":true,"retryOnFail":true,"credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.linha_tabela }}","rightValue":"Rota1 - ticketTabela","operator":{"type":"string","operation":"equals"},"id":"b53a2c98-1777-47a6-bb9c-3122c2c362ab"}],"combinator":"and"},"renameOutput":true,"outputKey":"Acks + Obs"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bb41d250-8bb6-4cfe-b2ce-b52df85a86b9","leftValue":"={{ $json.linha_tabela }}","rightValue":"Rota 3 - verificarZabbix","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Verificar Zabbix"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[1632,-288],"id":"0c74319b-d145-4a89-a2ab-377252e2cdcb","name":"Rotas"},{"parameters":{"operation":"getAll","tableId":"base","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"id_evento","condition":"eq","keyValue":"={{ $json.idEvento }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[928,400],"id":"00a9d793-d34e-4026-a493-3164771a0005","name":"Recupera dados da tabela","alwaysOutputData":true,"retryOnFail":true,"credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}},"disabled":true},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1376,496],"id":"05660782-836d-45ef-af26-f573d91712a8","name":"Fa√ßa nada","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"acccb782-9be4-49a2-a2e1-6fc9ae5066e4","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1152,400],"id":"1f87e01a-1fe5-4e84-bd8f-4d27726e0734","name":"Tem dados na tabela?","disabled":true},{"parameters":{"jsCode":"const nomeHost = $('Prepara os dados').first().json.nomeHost;\nconst nomeEvento = $('Prepara os dados').first().json.nomeEvento;\nconst timestampQueda = parseInt($('Prepara os dados').first().json.clock);\nconst dataHoraFormatada = DateTime.fromSeconds(timestampQueda).toFormat('dd/MM/yyyy HH:mm:ss')\nconst nomeHostLimpo = $('Prepara os dados').first().json.nomeHostLimpo;\n\n// ==== EXTRAIR OPERADORA DO NOME DO HOST ====\nfunction extrairOperadoraDoHost(nomeHostCompleto) {\n    if (!nomeHostCompleto) return \"\";\n    \n    // Divide o nome do host pelos h√≠fens\n    const partes = nomeHostCompleto.split(\" - \");\n    \n    // Se tiver pelo menos 3 partes, pega a segunda parte (√≠ndice 1)\n    if (partes.length >= 3) {\n        return partes[1].trim();\n    }\n    \n    // Se n√£o encontrar o padr√£o esperado, retorna o padr√£o\n    return \"\";\n}\n\nconst nomeLink = extrairOperadoraDoHost(nomeHost);\n\n// ==== VARI√ÅVEIS DO CLIENTE =====\nconst idCliente = \"1836303904\"// $input.first().json.ID ex.: \"1836303904\"; vari√°vel - pesquisar na planilha de dados do cliente\nconst emCopiaPara = \"\"; // 'william.semmler@maxprotection.com.br' + ',' + 'arthur.freschi@maxprotection.com.br' + ',' + 'fernanda.hernandez@maxprotection.com.br'; // vari√°vel - pesquisar na planilha de dados do cliente\n\n// ===== PREPARA√á√ÉO PARA CRIA√á√ÉO DO TICKET ====\nconst htmlCliente = `\n<p>teste encerramento do chamado</p>\n`;\n\n// ==== RETORNO QUE SER√Å USADO PELO HTTPREQUEST NO PR√ìXIMO N√ì ====\nreturn {\n  json: {\n    baseStatus: \"Resolved\",\n    status: \"Resolvido\",\n    justification: null,\n    // resolvedIn: \"2025-11-04T19:50:00Z\",\n    // closedIn: \"2025-11-04T20:00:00Z\",\n    actions: [\n      { type: 2, description: htmlCliente, createdBy: { id: \"1458772347\" } }\n    ]\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1376,304],"id":"b3f37677-9e9c-4893-b8da-1340568c7d09","name":"Prepara dados para abertura de chamado no Movidesk1","disabled":true},{"parameters":{"method":"PATCH","url":"=https://atendimento.maxprotection.com.br/public/v1/tickets?token=538206c9-60b4-4bf4-ae85-415ab9a68be6&id=129118","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1600,304],"id":"d85bf00d-412a-47c5-aa16-b4580625cc7e","name":"Movidesk: Informa cliente da indisponibilidade1","retryOnFail":true,"disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","authentication":"predefinedCredentialType","nodeCredentialType":"zabbixApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2528,-736],"id":"0162e11e-9293-4636-a4fd-6beecebe2ed4","name":"Atualiza evento Zabbix2","alwaysOutputData":false,"retryOnFail":true,"notesInFlow":false,"credentials":{"zabbixApi":{"id":"zl1coyXkQaqMlor1","name":"Zabbix"}},"disabled":true},{"parameters":{"jsCode":"const messageAcks = $('Recupera as linhas correspondentes').first().json.ticket_movidesk;\nconst eventId = $('Recupera as linhas correspondentes').first().json.id_evento;\n\n\nreturn {\n  jsonrpc: \"2.0\",\n  method: \"event.acknowledge\",\n  params: {\n    eventids: eventId,\n    message: String(messageAcks),\n    action: 6\n  },\n  auth: \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  id: 1\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2304,-736],"id":"ca4244aa-7e5a-45c2-88e8-3c76fd4e8f19","name":"Prepara para update mensagem correta3","disabled":true},{"parameters":{"operation":"update","tableId":"base","matchType":"allFilters","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('Recupera as linhas correspondentes').item.json.id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"qnd_quedas","fieldValue":"={{ $('Recupera as linhas correspondentes').item.json.qnd_quedas + 1 }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2080,-736],"id":"c37a72eb-1adc-48f9-989d-d136097f2da2","name":"Atualiza qnd_quedas no per√≠odo","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}},"disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","authentication":"predefinedCredentialType","nodeCredentialType":"zabbixApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2752,-544],"id":"5f65b1f1-7b01-4794-9c2f-ffab428a7e37","name":"Atualiza evento Zabbix3","alwaysOutputData":false,"retryOnFail":true,"notesInFlow":false,"credentials":{"zabbixApi":{"id":"zl1coyXkQaqMlor1","name":"Zabbix"}},"disabled":true},{"parameters":{"jsCode":"const messageAcks = $('Recupera as linhas correspondentes').first().json.ticket_movidesk;\nconst eventId = $('Prepara os dados').first().json.idEvento;\n\n\nreturn {\n  jsonrpc: \"2.0\",\n  method: \"event.acknowledge\",\n  params: {\n    eventids: eventId,\n    message: String(messageAcks),\n    action: 6\n  },\n  auth: \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  id: 1\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2528,-544],"id":"0d6cfd20-3857-45ef-8573-7d8fd1a2b463","name":"Prepara para update mensagem correta4","disabled":true},{"parameters":{"operation":"update","tableId":"base","matchType":"allFilters","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('Recupera as linhas correspondentes').item.json.id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"eventsRelacionados","fieldValue":"={{ $json.eventosRelacionadosAtualizado }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2304,-544],"id":"069b3879-acfa-47d4-8543-8b874506672f","name":"Atualiza linha do event matriz","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}},"disabled":true},{"parameters":{"method":"POST","url":"=https://atendimento.maxprotection.com.br/public/v1/tickets?token=538206c9-60b4-4bf4-ae85-415ab9a68be6","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2976,-288],"id":"4a2d9f83-878e-465a-86e2-bc1957db91c9","name":"Movidesk: Informa cliente da indisponibilidade","retryOnFail":true,"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"67371f0a-6119-4eaf-8f11-ce2becc7bc8b","leftValue":"={{ $('Recupera as linhas correspondentes').item.json.nome_host }}","rightValue":"={{ $('Prepara os dados').item.json.nomeHost }}","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1856,-640],"id":"5c7260a0-7e8d-47cf-bbfa-e7984be93e5f","name":"Confirma igualdade de host","disabled":true},{"parameters":{"jsCode":"const eventosRelacionados = $('Recupera as linhas correspondentes').first().json.eventsRelacionados;\nconst novoEvento = $('Prepara os dados').first().json.idEvento;\n\nconst eventosRelacionadosAtualizado = Array()\nfor (const event of eventosRelacionados) {\n  eventosRelacionadosAtualizado.push(event)\n}\n\neventosRelacionadosAtualizado.push(novoEvento)\n\nreturn [{eventosRelacionadosAtualizado}]"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2080,-544],"id":"ae89caf3-78fa-440b-a13e-7ddd16e8d4f1","name":"Prepara push para evento relacionados","disabled":true},{"parameters":{"content":"Finalizar implanta√ß√£o de encerramento de tickets no Movidesk","width":224,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1424,160],"id":"3a3fe6ec-f478-4869-8c10-576ef7d2417f","name":"Sticky Note","disabled":true},{"parameters":{"workflowInputs":{"values":[{"name":"idEvento"},{"name":"hostId","type":"number"},{"name":"nomeHost"},{"name":"nomeEvento"},{"name":"clock","type":"number"},{"name":"dataHoraQuedaFormatada"},{"name":"nomeHostLimpo"},{"name":"segundosVariavelCliente","type":"number"},{"name":"statusChamado"},{"name":"idClientetPlanilha","type":"number"},{"name":"relacaoClienteMax"},{"name":"idMovideskTickets","type":"number"},{"name":"destinatarioMovidesk"},{"name":"ccMovidesk"}]}},"id":"c055762a-8fe7-4141-a639-df2372f30060","typeVersion":1.1,"name":"Main","type":"n8n-nodes-base.executeWorkflowTrigger","position":[128,64]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"cc1def41-b486-40e0-a4c2-5862b24ac381","leftValue":"={{ $json.statusChamado }}","rightValue":"Abertura Chamado","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[576,64],"id":"d4cb7294-3fe8-4f3e-aff6-a133d1b44d4d","name":"Abertura chamado?"},{"parameters":{"assignments":{"assignments":[{"id":"85ae8ed7-12c2-48da-8a0a-52a205fb5848","name":"idEvento","value":"={{ $json.idEvento }}","type":"number"},{"id":"69427fce-cee5-4557-ac53-ed4a959d1397","name":"hostId","value":"={{ $json.hostId }}","type":"number"},{"id":"3ef4dd92-d549-430c-afad-a0e64539a369","name":"nomeHost","value":"={{ $json.nomeHost }}","type":"string"},{"id":"64de0cd4-da96-4a1c-ac48-9608aaa30536","name":"nomeEvento","value":"={{ $json.nomeEvento }}","type":"string"},{"id":"19d6464e-74bd-449c-b7c4-6d0a4c09627a","name":"clock","value":"={{ $json.clock }}","type":"number"},{"id":"f921bb38-a7b2-4ab1-a153-b32b6e656a6a","name":"dataHoraQuedaFormatada","value":"={{ $json.dataHoraQuedaFormatada }}","type":"string"},{"id":"4db93430-04f6-42dc-9dff-1626b1e0e822","name":"nomeHostLimpo","value":"={{ $json.nomeHostLimpo }}","type":"string"},{"id":"1573df28-c2ca-4582-a33d-5bfe25edc90f","name":"segundosVariavelCliente","value":"={{ $json.segundosVariavelCliente }}","type":"number"},{"id":"82e7552f-d602-4da8-925c-45802f2b964c","name":"statusChamado","value":"={{ $json.statusChamado }}","type":"string"},{"id":"5dc0759b-efe7-48b6-9df1-315733e4e91f","name":"idClientetPlanilha","value":"={{ $json.idClientetPlanilha }}","type":"number"},{"id":"660a7b1d-f372-4439-87b2-36a87f3fd0db","name":"relacaoClienteMax","value":"={{ $json.relacaoClienteMax }}","type":"string"},{"id":"765c6827-e140-448e-b3a6-ab65235a822d","name":"idMovideskTickets","value":"={{ $json.idMovideskTickets }}","type":"string"},{"id":"86c0cc80-aa5b-4a11-82c3-75adb4d6e4b8","name":"destinatarioMovidesk","value":"={{ $json.destinatarioMovidesk }}","type":"string"},{"id":"0b26f6ce-86f1-4996-90c9-394bdb1221e7","name":"ccMovidesk","value":"={{ $json.ccMovidesk }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[352,64],"id":"c2b90d36-ec6c-4bbc-95a2-e34b6d30ce1e","name":"Prepara os dados1"}],"connections":{"Subtrai tempo vari√°vel cliente do tempo atual":{"main":[[{"node":"Recupera as linhas correspondentes","type":"main","index":0}]]},"Valida se existe ticket e direciona":{"main":[[{"node":"Rotas","type":"main","index":0}]]},"Separa alertas com acks === 6":{"main":[[{"node":"Se vazio, ent√£o abrir chamado","type":"main","index":0}]]},"Consulta por eventos anteriores":{"main":[[{"node":"Separa alertas com acks === 6","type":"main","index":0}]]},"Se vazio, ent√£o abrir chamado":{"main":[[{"node":"Recupera dados do cliente na planilha","type":"main","index":0}],[{"node":"Prepara dados para ack","type":"main","index":0}]]},"Prepara dados para ack":{"main":[[{"node":"Valida se existe ticket Movidesk","type":"main","index":0}]]},"Prepara para update mensagem correta1":{"main":[[{"node":"Atualiza evento Zabbix","type":"main","index":0},{"node":"Atualiza a equipe sobre o alerta sem ticket","type":"main","index":0}]]},"Adiciona nova linha na tabela":{"main":[[{"node":"Prepara para update mensagem correta1","type":"main","index":0}]]},"Adiciona nova linha na tabela1":{"main":[[{"node":"Prepara para update mensagem correta","type":"main","index":0}]]},"Prepara para update mensagem correta":{"main":[[{"node":"Atualiza evento Zabbix","type":"main","index":0},{"node":"Atualiza a equipe sobre o alerta com ticket","type":"main","index":0}]]},"Valida se existe ticket Movidesk":{"main":[[{"node":"Adiciona nova linha na tabela","type":"main","index":0}],[{"node":"Adiciona nova linha na tabela1","type":"main","index":0}]]},"Atualiza evento Zabbix":{"main":[[]]},"Prepara dados para abertura de chamado no Movidesk":{"main":[[{"node":"Movidesk: Informa cliente da indisponibilidade","type":"main","index":0}]]},"Cria linha de chamado aberto":{"main":[[{"node":"Prepara para update mensagem correta2","type":"main","index":0}]]},"Prepara para update mensagem correta2":{"main":[[{"node":"Atualiza evento Zabbix1","type":"main","index":0}]]},"Recupera dados do cliente na planilha":{"main":[[{"node":"Prepara dados para abertura de chamado no Movidesk","type":"main","index":0}]]},"Recupera as linhas correspondentes":{"main":[[{"node":"Valida se existe ticket e direciona","type":"main","index":0}]]},"Rotas":{"main":[[{"node":"Confirma igualdade de host","type":"main","index":0}],[{"node":"Consulta por eventos anteriores","type":"main","index":0}]]},"Recupera dados da tabela":{"main":[[{"node":"Tem dados na tabela?","type":"main","index":0}]]},"Tem dados na tabela?":{"main":[[{"node":"Prepara dados para abertura de chamado no Movidesk1","type":"main","index":0}],[{"node":"Fa√ßa nada","type":"main","index":0}]]},"Prepara dados para abertura de chamado no Movidesk1":{"main":[[{"node":"Movidesk: Informa cliente da indisponibilidade1","type":"main","index":0}]]},"Prepara para update mensagem correta3":{"main":[[{"node":"Atualiza evento Zabbix2","type":"main","index":0}]]},"Atualiza qnd_quedas no per√≠odo":{"main":[[{"node":"Prepara para update mensagem correta3","type":"main","index":0}]]},"Prepara para update mensagem correta4":{"main":[[{"node":"Atualiza evento Zabbix3","type":"main","index":0}]]},"Atualiza linha do event matriz":{"main":[[{"node":"Prepara para update mensagem correta4","type":"main","index":0}]]},"Movidesk: Informa cliente da indisponibilidade":{"main":[[{"node":"Cria linha de chamado aberto","type":"main","index":0}]]},"Confirma igualdade de host":{"main":[[{"node":"Atualiza qnd_quedas no per√≠odo","type":"main","index":0}],[{"node":"Prepara push para evento relacionados","type":"main","index":0}]]},"Prepara push para evento relacionados":{"main":[[{"node":"Atualiza linha do event matriz","type":"main","index":0}]]},"Main":{"main":[[{"node":"Prepara os dados1","type":"main","index":0}]]},"Prepara os dados1":{"main":[[{"node":"Abertura chamado?","type":"main","index":0}]]},"Abertura chamado?":{"main":[[{"node":"Subtrai tempo vari√°vel cliente do tempo atual","type":"main","index":0}],[{"node":"Recupera dados da tabela","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Main":[{"json":{"idEvento":172615510,"hostId":17680,"nomeHost":"PLANALTO POA - LINK X2 AVATO 100MB -  177.130.39.178","nomeEvento":"Indispon√≠vel via ICMP","clock":1762428974,"dataHoraQuedaFormatada":"06/11/2025, 08:36:14","nomeHostLimpo":"PLANALTO POA","segundosVariavelCliente":86400,"statusChamado":"Abertura Chamado","idClientetPlanilha":null,"relacaoClienteMax":"GERAL","idMovideskTickets":null,"destinatarioMovidesk":"adriana.santos@jmt.com.br","ccMovidesk":"jefferson.lorsson@jmt.com.br"}}]},"versionId":"393a8d9b-796d-4802-8fb3-05718be9460b","activeVersionId":"393a8d9b-796d-4802-8fb3-05718be9460b","triggerCount":0,"shared":[{"updatedAt":"2025-11-04T16:50:19.701Z","createdAt":"2025-11-04T16:50:19.701Z","role":"workflow:owner","workflowId":"zHtexh2XplMfRpSW","projectId":"UcF1WBdewsFeRVFr"}],"activeVersion":{"updatedAt":"2026-01-27T16:47:39.129Z","createdAt":"2026-01-27T16:47:39.129Z","versionId":"393a8d9b-796d-4802-8fb3-05718be9460b","workflowId":"zHtexh2XplMfRpSW","nodes":[{"parameters":{"jsCode":"const timestampQuedaLink = $input.first().json.clock;\nconst segundosTempoAtras = $input.first().json.segundosVariavelCliente;\n\nconst timestampMenosTempoAtras = timestampQuedaLink - segundosTempoAtras;\n\nreturn {\n  \"timestampQueda\": timestampQuedaLink,\n  \"timestampQueda_formatada\": DateTime.fromSeconds(timestampQuedaLink).setZone('America/Sao_Paulo').toFormat('dd/MM/yyyy HH:mm:ss'),\n  \"timestamp_queda_decrescido_tempo_cliente\": timestampMenosTempoAtras,\n  \"timestamp_queda_decrescido_tempo_cliente_formatado\": DateTime.fromSeconds(timestampMenosTempoAtras).setZone('America/Sao_Paulo').toFormat('dd/MM/yyyy HH:mm:ss')\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[960,-288],"id":"04632aa8-5b4a-4e4f-98bd-0311ba0ab171","name":"Subtrai tempo vari√°vel cliente do tempo atual"},{"parameters":{"jsCode":"const idEventoTabela = $input.first().json.id;\nconst ticketMovideskTabela = $input.first().json.ticket_movidesk;\n\nif ((idEventoTabela && ticketMovideskTabela) || (idEventoTabela && ticketMovideskTabela == 0) ) {\n  return { \n    \"linha_tabela\": \"Rota1 - ticketTabela\",\n    \"descricao\": \"Com evento e ticket na tabela\"\n  }\n} else if (!idEventoTabela && !ticketMovideskTabela) {\n  return {\n    \"linha_tabela\": \"Rota 3 - verificarZabbix\",\n    \"descricao\": \"Sem evento na tabela\"\n  }\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1408,-288],"id":"e52a25d3-5e03-463f-80ea-820ab23f9bf0","name":"Valida se existe ticket e direciona"},{"parameters":{"jsCode":"// Filtra apenas eventos com algum acknowledge de action == \"6\"\nconst eventos = $input.first().json.result;\n\n// Filtra apenas eventos que t√™m pelo menos um ack com action == \"6\"\nconst filtrados = eventos\n  .filter(ev => ev.acknowledges?.some(ack => ack.action == 6))\n  .map(ev => {\n    // Dentro de cada evento, pega s√≥ os acks com action == 6\n    const acks6 = (ev.acknowledges || []).filter(ack => ack.action == 6);\n\n    // Ordena por acknowledgeid (num√©rico) e pega o maior\n    const ackMaior = [...acks6].sort((a, b) => Number(b.acknowledgeid) - Number(a.acknowledgeid))[0];\n\n    // Retorna o evento com destaque para o acknowledge mais recente\n    return {\n      json: {\n        eventid: ev.eventid,\n        clock: ev.clock,\n        hostid: ev.hosts?.[0]?.hostid,\n        host: ev.hosts?.[0]?.host,\n        value: ev.value,\n        // acknowledge de maior id\n        acknowledge_mais_recente: {\n          acknowledgeid: ackMaior.acknowledgeid,\n          clock: ackMaior.clock,\n          \"timestampAck_formatado\": DateTime.fromSeconds(parseInt(ackMaior.clock))\n            .setZone('America/Sao_Paulo')\n            .toFormat('dd/MM/yyyy HH:mm:ss'),\n          message: ackMaior.message,\n          action: ackMaior.action,\n          username: ackMaior.username,\n          userid: ackMaior.userid\n        }\n      }\n    };\n  });\n\n// Retorna cada evento filtrado como item independente\nif (filtrados.length === 0) {\n  return {\n    json: {\n      \"acksFiltrados\": {\n        filtrados, \n        \"status\": false\n      }\n    }\n  }\n} else {\n  return {\n    json: {\n      \"acksFiltrados\": {\n        filtrados, \n        \"status\": true\n      }\n    }\n  }\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2080,0],"id":"ff5042f8-4bfa-46b6-a497-cd3408cdd8dd","name":"Separa alertas com acks === 6"},{"parameters":{"url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"event.get\",\n  \"params\": {\n    \"output\": [\"eventid\", \"clock\", \"name\", \"value\", \"host\", \"hostid\"],\n    \"select_acknowledges\": [\n      \"acknowledgeid\",\n      \"userid\",\n      \"eventid\",\n      \"clock\",\n      \"message\",\n      \"action\",\n      \"username\"\n    ],\n    \"time_from\": \"{{ $('Subtrai tempo vari√°vel cliente do tempo atual').item.json.timestamp_queda_decrescido_tempo_cliente }}\",\n    \"selectHosts\": [\"hostid\", \"host\"],\n    \"hostids\": \"{{ $('Prepara os dados1').item.json.hostId }}\",\n    \"sortfield\": \"clock\",\n    \"sortorder\": \"DESC\"\n  },\n  \"auth\": \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  \"id\": 1\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1856,0],"id":"c91e9e5b-da29-493f-8e5f-c192cd964088","name":"Consulta por eventos anteriores","alwaysOutputData":false,"retryOnFail":true,"notesInFlow":false},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"cb6eff08-3023-4783-bfaf-1cacf44c64ab","leftValue":"={{ $json.acksFiltrados.status }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2304,0],"id":"186bdf27-98f7-480c-894f-132c73f62b1c","name":"Se vazio, ent√£o abrir chamado"},{"parameters":{"jsCode":"// Obt√©m a mensagem\nlet messageTicket = $input.first().json.acksFiltrados.filtrados[0].json.acknowledge_mais_recente.message;\n\nlet numeroTicket;\n\n// Tenta encontrar n√∫meros na mensagem\nlet numerosEncontrados = messageTicket.match(/\\d+/);\n\nif (numerosEncontrados && numerosEncontrados.length > 0) {\n    numeroTicket = parseInt(numerosEncontrados[0]);\n} else {\n    // Se n√£o encontrar n√∫meros, retorna o texto completo\n    numeroTicket = messageTicket;\n}\n\n// Verifica se o valor √© uma string (n√£o num√©rica)\nif (typeof(numeroTicket) === \"string\") {\n  return [\n    { \n      ticket: 0,\n      message: messageTicket\n    }\n  ];\n} else {\n  return [\n    { \n      ticketMovidesk: numeroTicket,\n      message: messageTicket\n    }\n  ];\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2528,96],"id":"3de62352-0fc9-491a-a5d8-08b9e131f4be","name":"Prepara dados para ack"},{"parameters":{"tableId":"base"},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2976,-48],"id":"6576f3dc-a96b-42bd-bd0f-c82138d26116","name":"Adiciona nova linha na tabela","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}}},{"parameters":{"tableId":"base","fieldsUi":{"fieldValues":[{"fieldId":"id_host","fieldValue":"={{ parseInt($('Prepara os dados').item.json.hostId) }}"},{"fieldId":"ticket_movidesk","fieldValue":"={{ parseInt($json.message) }}"},{"fieldId":"timestamp_queda","fieldValue":"={{ parseInt($('Prepara os dados').item.json.clock) }}"},{"fieldId":"id_cliente_variaveis","fieldValue":"3"},{"fieldId":"status_chamado","fieldValue":"2"},{"fieldId":"id_evento","fieldValue":"={{ parseInt($('Prepara os dados').item.json.idEvento) }}"},{"fieldId":"evento_raiz","fieldValue":"={{ parseInt($('Prepara os dados').item.json.idEvento) }}"},{"fieldId":"nome_host","fieldValue":"={{ $('Prepara os dados').item.json.nomeHost }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2976,240],"id":"68df18f1-cc02-4d3e-a868-6e4cefb7e60a","name":"Adiciona nova linha na tabela1","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}}},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","authentication":"predefinedCredentialType","nodeCredentialType":"zabbixApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3424,96],"id":"52892d43-3ffc-43df-8de3-b532378be74e","name":"Atualiza evento Zabbix","alwaysOutputData":false,"retryOnFail":true,"notesInFlow":false,"credentials":{"zabbixApi":{"id":"zl1coyXkQaqMlor1","name":"Zabbix"}},"disabled":true},{"parameters":{"jsCode":"const messageAcks = $('Separa alertas com acks === 6').first().json.acksFiltrados.filtrados[0].json.acknowledge_mais_recente.message;\nconst eventId = $input.first().json.id_evento;\n\n\nreturn {\n  jsonrpc: \"2.0\",\n  method: \"event.acknowledge\",\n  params: {\n    eventids: eventId,\n    message: String(messageAcks),\n    action: 6\n  },\n  auth: \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  id: 1\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3200,-48],"id":"32f5c98b-c80e-4f04-bf86-dcd695d348bc","name":"Prepara para update mensagem correta1","disabled":true},{"parameters":{"jsCode":"const messageAcks = $input.first().json.ticket_movidesk;\nconst eventId = $('Prepara os dados').first().json.idEvento;\n\nreturn {\n  jsonrpc: \"2.0\",\n  method: \"event.acknowledge\",\n  params: {\n    eventids: eventId,\n    message: String(messageAcks),\n    action: 6\n  },\n  auth: \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  id: 1\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3200,240],"id":"d209c0aa-dd88-42b3-acae-7eb6c32c2788","name":"Prepara para update mensagem correta","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b83ec77b-2171-41f1-b0ba-869e5b6233bd","leftValue":"={{ $json.ticketMovidesk }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2752,96],"id":"6e598a7d-627f-4646-be52-f42dddc739f9","name":"Valida se existe ticket Movidesk"},{"parameters":{"authentication":"webhook","options":{},"embeds":{"values":[{"description":"=*Nota: o evento foi atualizado com o √∫timo ticket registrado no Zabbix porque ainda est√° dentro do per√≠odo de valida√ß√£o de restabelecimento*\n\nüñ•Ô∏è **Host:** {{ $('Prepara os dados').item.json.nomeHost }}\nüìõ **Nome do alerta:** {{ $('Prepara os dados').item.json.nomeEvento }}\nüïí **Data e hora do evento:** {{ $('Subtrai tempo vari√°vel cliente do tempo atual').item.json.timestamp_queda_decrescido_tempo_cliente_formatado }}\nüïí **Data e hora da atualiza√ß√£o:** {{ DateTime.now().format('dd/MM/yyyy HH:mm:ss')}}\nüéüÔ∏è **Ticket Movidesk:** $input.first().json.ticket_movidesk\n\nüìÑ **Linha no BD:** {{ $('Adiciona nova linha na tabela').item.json.sid }}\n\n","color":"#25FF2C","title":"üö® O seguinte evento foi atualizado no Zabbix e na tabela"}]}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[3424,288],"id":"b59c54a6-9510-4f58-92e9-0fb267f2c962","name":"Atualiza a equipe sobre o alerta com ticket","webhookId":"eeed722b-607e-4597-8511-e54a55e53154","retryOnFail":true,"credentials":{"discordWebhookApi":{"id":"cpyl61bJ83gXe4YH","name":"Canal: abertura de chamados e atualiza√ß√µes"}},"disabled":true},{"parameters":{"authentication":"webhook","options":{},"embeds":{"values":[{"description":"=*Nota: o evento foi atualizado com o √∫timo ticket registrado no Zabbix porque ainda est√° dentro do per√≠odo de valida√ß√£o de restabelecimento*\n\nüñ•Ô∏è **Host:** {{ $('Prepara os dados').item.json.nomeHost }}\nüìõ **Nome do alerta:** {{ $('Prepara os dados').item.json.nomeEvento }}\nüïí **Data e hora do evento:** {{ $('Subtrai tempo vari√°vel cliente do tempo atual').item.json.timestamp_queda_decrescido_tempo_cliente_formatado }}\nüïí **Data e hora da atualiza√ß√£o:** {{ DateTime.now().format('dd/MM/yyyy HH:mm:ss')}}\nüéüÔ∏è **Ticket Movidesk:** N√£o criado\n\nüìÑ **Linha no BD:** {{ $('Adiciona nova linha na tabela').item.json.sid }}\n\n","color":"#25FF2C","title":"üö® O seguinte evento foi atualizado no Zabbix e na tabela"}]}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[3424,-96],"id":"f88eca65-5c25-42f9-819a-46238b51e0f9","name":"Atualiza a equipe sobre o alerta sem ticket","webhookId":"eeed722b-607e-4597-8511-e54a55e53154","retryOnFail":true,"credentials":{"discordWebhookApi":{"id":"cpyl61bJ83gXe4YH","name":"Canal: abertura de chamados e atualiza√ß√µes"}},"disabled":true},{"parameters":{"jsCode":"const nomeHost = $('Prepara os dados').first().json.nomeHost;\nconst nomeEvento = $('Prepara os dados').first().json.nomeEvento;\nconst timestampQueda = parseInt($('Prepara os dados').first().json.clock);\nconst dataHoraFormatada = DateTime.fromSeconds(timestampQueda).toFormat('dd/MM/yyyy HH:mm:ss')\nconst nomeHostLimpo = $('Prepara os dados').first().json.nomeHostLimpo;\n\n// ==== EXTRAIR OPERADORA DO NOME DO HOST ====\nfunction extrairOperadoraDoHost(nomeHostCompleto) {\n    if (!nomeHostCompleto) return \"(NOME DA OPERADORA)\";\n    \n    // Divide o nome do host pelos h√≠fens\n    const partes = nomeHostCompleto.split(\" - \");\n    \n    // Se tiver pelo menos 3 partes, pega a segunda parte (√≠ndice 1)\n    if (partes.length >= 3) {\n        return partes[1].trim();\n    }\n    \n    // Se n√£o encontrar o padr√£o esperado, retorna o padr√£o\n    return \"\";\n}\n\nconst nomeLink = extrairOperadoraDoHost(nomeHost);\n\n// ==== VARI√ÅVEIS DO CLIENTE =====\nconst idCliente = \"1836303904\"// $input.first().json.ID ex.: \"1836303904\"; vari√°vel - pesquisar na planilha de dados do cliente\nconst emCopiaPara = \"\"; // 'william.semmler@maxprotection.com.br' + ',' + 'arthur.freschi@maxprotection.com.br' + ',' + 'fernanda.hernandez@maxprotection.com.br'; // vari√°vel - pesquisar na planilha de dados do cliente\n\n// ===== PREPARA√á√ÉO PARA CRIA√á√ÉO DO TICKET ====\nconst htmlCliente = `\n<p>Boa tarde.</p>\n<br>\n<p>Identificamos o seguinte alerta em nosso sistema de monitoramento:</p>\n\n<div style=\"padding: 10px; border: 1px solid black; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; text-align: center; align-items: center; color: black; margin: 10px 0\">\n  <h2>${nomeHost}</h2>\n  <p style=\"font-size: 16px;\"><strong>Evento:</strong> ${nomeEvento}</p>\n  <p style=\"font-size: 16px;\"><strong>Data e hora da queda:</strong> ${dataHoraFormatada}</p>\n</div>\n\n<p> Gostar√≠amos de confirmar se a ocorr√™ncia j√° √© de conhecimento da equipe ${nomeHostLimpo} ou se trata de uma falha eventual? </p>\n<p>Recomendamos a verifica√ß√£o da ocorr√™ncia acima para valida√ß√£o e tratativa da indisponibilidade. Permaneceremos em monitoramento e informaremos quando o evento estiver com status de resolvido em nosso monitoramento.</p>\n`;\n\n// ==== RETORNO QUE SER√Å USADO PELO HTTPREQUEST NO PR√ìXIMO N√ì ====\nreturn {\n  json: {\n    type: 2,\n    subject: `REPARO - ${nomeHostLimpo} - ${nomeLink}`,\n    category: \"01 - Atendimento Helpdesk\",\n    serviceFirstLevelId: 325878,\n    urgency: \"M√©dia\",\n    ownerTeam: \"NOC\",\n    status: \"Aguardando\",\n    justification: \"Valida√ß√£o\",\n    createdBy: { id: \"1458772347\" },\n    Clients: [{ id: idCliente }],\n    cc: emCopiaPara,\n    actions: [\n      { type: 2, description: htmlCliente, createdBy: { id: \"1458772347\" } }\n    ]\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2752,-288],"id":"ecb352b5-213f-4f5c-a1ef-982ec9835593","name":"Prepara dados para abertura de chamado no Movidesk","disabled":true},{"parameters":{"tableId":"base","fieldsUi":{"fieldValues":[{"fieldId":"id_host","fieldValue":"={{ parseInt($('Prepara os dados').item.json.hostId) }}"},{"fieldId":"nome_host","fieldValue":"={{ $('Prepara os dados').item.json.nomeHost }}"},{"fieldId":"ticket_movidesk","fieldValue":"={{ $json.id }}"},{"fieldId":"timestamp_queda","fieldValue":"={{ parseInt($('Prepara os dados').item.json.clock) }}"},{"fieldId":"id_cliente_variaveis","fieldValue":"3"},{"fieldId":"status_chamado","fieldValue":"2"},{"fieldId":"id_evento","fieldValue":"={{ parseInt($('Prepara os dados').item.json.idEvento) }}"},{"fieldId":"evento_raiz","fieldValue":"={{ parseInt($('Prepara os dados').item.json.idEvento) }}"},{"fieldId":"hostLimpo","fieldValue":"={{ $('Prepara os dados').item.json.nomeHostLimpo }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3200,-288],"id":"f7213133-7f85-4d57-8030-781a14215d79","name":"Cria linha de chamado aberto","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}},"disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","authentication":"predefinedCredentialType","nodeCredentialType":"zabbixApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3648,-288],"id":"fb9fc168-76b4-42c7-a339-76914f49ea38","name":"Atualiza evento Zabbix1","alwaysOutputData":false,"retryOnFail":true,"notesInFlow":false,"credentials":{"zabbixApi":{"id":"zl1coyXkQaqMlor1","name":"Zabbix"}},"disabled":true},{"parameters":{"jsCode":"const messageAcks = $input.first().json.ticket_movidesk;\nconst eventId = $input.first().json.id_evento;\n\n\nreturn {\n  jsonrpc: \"2.0\",\n  method: \"event.acknowledge\",\n  params: {\n    eventids: eventId,\n    message: String(messageAcks),\n    action: 6\n  },\n  auth: \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  id: 1\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3424,-288],"id":"dcacb891-1c78-463e-a33d-ceb9e7732f11","name":"Prepara para update mensagem correta2","disabled":true},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"11ynejkll5Q6J6AJ--R3sIxLMyyd3AbTaTS9ncm1KQMs","mode":"list","cachedResultName":"Contato empresas","cachedResultUrl":"https://docs.google.com/spreadsheets/d/11ynejkll5Q6J6AJ--R3sIxLMyyd3AbTaTS9ncm1KQMs/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":195655548,"mode":"list","cachedResultName":"Contatos_n8n","cachedResultUrl":"https://docs.google.com/spreadsheets/d/11ynejkll5Q6J6AJ--R3sIxLMyyd3AbTaTS9ncm1KQMs/edit#gid=195655548"},"filtersUI":{"values":[{"lookupColumn":"EMPRESA","lookupValue":"={{ $('Prepara os dados').item.json.nomeHostLimpo }}"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2528,-288],"id":"8d878d66-9b38-4a39-aa81-ac0934145bde","name":"Recupera dados do cliente na planilha","alwaysOutputData":true,"credentials":{"googleApi":{"id":"G23Xn5Fl7KzKph4r","name":"Google Service Account account"}},"disabled":true},{"parameters":{"operation":"getAll","tableId":"base","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"hostLimpo","condition":"eq","keyValue":"={{ $('Prepara os dados1').item.json.nomeHostLimpo }}"},{"keyName":"timestamp_queda","condition":"gte","keyValue":"={{ $json.timestamp_queda_decrescido_tempo_cliente }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1184,-288],"id":"d3ea3222-8a0c-48fe-91e3-4a5f132534b6","name":"Recupera as linhas correspondentes","alwaysOutputData":true,"retryOnFail":true,"credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.linha_tabela }}","rightValue":"Rota1 - ticketTabela","operator":{"type":"string","operation":"equals"},"id":"b53a2c98-1777-47a6-bb9c-3122c2c362ab"}],"combinator":"and"},"renameOutput":true,"outputKey":"Acks + Obs"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bb41d250-8bb6-4cfe-b2ce-b52df85a86b9","leftValue":"={{ $json.linha_tabela }}","rightValue":"Rota 3 - verificarZabbix","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Verificar Zabbix"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[1632,-288],"id":"0c74319b-d145-4a89-a2ab-377252e2cdcb","name":"Rotas"},{"parameters":{"operation":"getAll","tableId":"base","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"id_evento","condition":"eq","keyValue":"={{ $json.idEvento }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[928,400],"id":"00a9d793-d34e-4026-a493-3164771a0005","name":"Recupera dados da tabela","alwaysOutputData":true,"retryOnFail":true,"credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}},"disabled":true},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1376,496],"id":"05660782-836d-45ef-af26-f573d91712a8","name":"Fa√ßa nada","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"acccb782-9be4-49a2-a2e1-6fc9ae5066e4","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1152,400],"id":"1f87e01a-1fe5-4e84-bd8f-4d27726e0734","name":"Tem dados na tabela?","disabled":true},{"parameters":{"jsCode":"const nomeHost = $('Prepara os dados').first().json.nomeHost;\nconst nomeEvento = $('Prepara os dados').first().json.nomeEvento;\nconst timestampQueda = parseInt($('Prepara os dados').first().json.clock);\nconst dataHoraFormatada = DateTime.fromSeconds(timestampQueda).toFormat('dd/MM/yyyy HH:mm:ss')\nconst nomeHostLimpo = $('Prepara os dados').first().json.nomeHostLimpo;\n\n// ==== EXTRAIR OPERADORA DO NOME DO HOST ====\nfunction extrairOperadoraDoHost(nomeHostCompleto) {\n    if (!nomeHostCompleto) return \"\";\n    \n    // Divide o nome do host pelos h√≠fens\n    const partes = nomeHostCompleto.split(\" - \");\n    \n    // Se tiver pelo menos 3 partes, pega a segunda parte (√≠ndice 1)\n    if (partes.length >= 3) {\n        return partes[1].trim();\n    }\n    \n    // Se n√£o encontrar o padr√£o esperado, retorna o padr√£o\n    return \"\";\n}\n\nconst nomeLink = extrairOperadoraDoHost(nomeHost);\n\n// ==== VARI√ÅVEIS DO CLIENTE =====\nconst idCliente = \"1836303904\"// $input.first().json.ID ex.: \"1836303904\"; vari√°vel - pesquisar na planilha de dados do cliente\nconst emCopiaPara = \"\"; // 'william.semmler@maxprotection.com.br' + ',' + 'arthur.freschi@maxprotection.com.br' + ',' + 'fernanda.hernandez@maxprotection.com.br'; // vari√°vel - pesquisar na planilha de dados do cliente\n\n// ===== PREPARA√á√ÉO PARA CRIA√á√ÉO DO TICKET ====\nconst htmlCliente = `\n<p>teste encerramento do chamado</p>\n`;\n\n// ==== RETORNO QUE SER√Å USADO PELO HTTPREQUEST NO PR√ìXIMO N√ì ====\nreturn {\n  json: {\n    baseStatus: \"Resolved\",\n    status: \"Resolvido\",\n    justification: null,\n    // resolvedIn: \"2025-11-04T19:50:00Z\",\n    // closedIn: \"2025-11-04T20:00:00Z\",\n    actions: [\n      { type: 2, description: htmlCliente, createdBy: { id: \"1458772347\" } }\n    ]\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1376,304],"id":"b3f37677-9e9c-4893-b8da-1340568c7d09","name":"Prepara dados para abertura de chamado no Movidesk1","disabled":true},{"parameters":{"method":"PATCH","url":"=https://atendimento.maxprotection.com.br/public/v1/tickets?token=538206c9-60b4-4bf4-ae85-415ab9a68be6&id=129118","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1600,304],"id":"d85bf00d-412a-47c5-aa16-b4580625cc7e","name":"Movidesk: Informa cliente da indisponibilidade1","retryOnFail":true,"disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","authentication":"predefinedCredentialType","nodeCredentialType":"zabbixApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2528,-736],"id":"0162e11e-9293-4636-a4fd-6beecebe2ed4","name":"Atualiza evento Zabbix2","alwaysOutputData":false,"retryOnFail":true,"notesInFlow":false,"credentials":{"zabbixApi":{"id":"zl1coyXkQaqMlor1","name":"Zabbix"}},"disabled":true},{"parameters":{"jsCode":"const messageAcks = $('Recupera as linhas correspondentes').first().json.ticket_movidesk;\nconst eventId = $('Recupera as linhas correspondentes').first().json.id_evento;\n\n\nreturn {\n  jsonrpc: \"2.0\",\n  method: \"event.acknowledge\",\n  params: {\n    eventids: eventId,\n    message: String(messageAcks),\n    action: 6\n  },\n  auth: \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  id: 1\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2304,-736],"id":"ca4244aa-7e5a-45c2-88e8-3c76fd4e8f19","name":"Prepara para update mensagem correta3","disabled":true},{"parameters":{"operation":"update","tableId":"base","matchType":"allFilters","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('Recupera as linhas correspondentes').item.json.id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"qnd_quedas","fieldValue":"={{ $('Recupera as linhas correspondentes').item.json.qnd_quedas + 1 }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2080,-736],"id":"c37a72eb-1adc-48f9-989d-d136097f2da2","name":"Atualiza qnd_quedas no per√≠odo","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}},"disabled":true},{"parameters":{"method":"POST","url":"https://monitoramento.maxprotection.com.br/zabbix/api_jsonrpc.php","authentication":"predefinedCredentialType","nodeCredentialType":"zabbixApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json-rpc"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2752,-544],"id":"5f65b1f1-7b01-4794-9c2f-ffab428a7e37","name":"Atualiza evento Zabbix3","alwaysOutputData":false,"retryOnFail":true,"notesInFlow":false,"credentials":{"zabbixApi":{"id":"zl1coyXkQaqMlor1","name":"Zabbix"}},"disabled":true},{"parameters":{"jsCode":"const messageAcks = $('Recupera as linhas correspondentes').first().json.ticket_movidesk;\nconst eventId = $('Prepara os dados').first().json.idEvento;\n\n\nreturn {\n  jsonrpc: \"2.0\",\n  method: \"event.acknowledge\",\n  params: {\n    eventids: eventId,\n    message: String(messageAcks),\n    action: 6\n  },\n  auth: \"613a673311516e26fae52c8386f701a8e0d5f15909f47dd4f990f06d81d2c0a7\",\n  id: 1\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2528,-544],"id":"0d6cfd20-3857-45ef-8573-7d8fd1a2b463","name":"Prepara para update mensagem correta4","disabled":true},{"parameters":{"operation":"update","tableId":"base","matchType":"allFilters","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('Recupera as linhas correspondentes').item.json.id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"eventsRelacionados","fieldValue":"={{ $json.eventosRelacionadosAtualizado }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2304,-544],"id":"069b3879-acfa-47d4-8543-8b874506672f","name":"Atualiza linha do event matriz","credentials":{"supabaseApi":{"id":"LGj9FXtwnJ9tLnw3","name":"Supabase account"}},"disabled":true},{"parameters":{"method":"POST","url":"=https://atendimento.maxprotection.com.br/public/v1/tickets?token=538206c9-60b4-4bf4-ae85-415ab9a68be6","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2976,-288],"id":"4a2d9f83-878e-465a-86e2-bc1957db91c9","name":"Movidesk: Informa cliente da indisponibilidade","retryOnFail":true,"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"67371f0a-6119-4eaf-8f11-ce2becc7bc8b","leftValue":"={{ $('Recupera as linhas correspondentes').item.json.nome_host }}","rightValue":"={{ $('Prepara os dados').item.json.nomeHost }}","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1856,-640],"id":"5c7260a0-7e8d-47cf-bbfa-e7984be93e5f","name":"Confirma igualdade de host","disabled":true},{"parameters":{"jsCode":"const eventosRelacionados = $('Recupera as linhas correspondentes').first().json.eventsRelacionados;\nconst novoEvento = $('Prepara os dados').first().json.idEvento;\n\nconst eventosRelacionadosAtualizado = Array()\nfor (const event of eventosRelacionados) {\n  eventosRelacionadosAtualizado.push(event)\n}\n\neventosRelacionadosAtualizado.push(novoEvento)\n\nreturn [{eventosRelacionadosAtualizado}]"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2080,-544],"id":"ae89caf3-78fa-440b-a13e-7ddd16e8d4f1","name":"Prepara push para evento relacionados","disabled":true},{"parameters":{"content":"Finalizar implanta√ß√£o de encerramento de tickets no Movidesk","width":224,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1424,160],"id":"3a3fe6ec-f478-4869-8c10-576ef7d2417f","name":"Sticky Note","disabled":true},{"parameters":{"workflowInputs":{"values":[{"name":"idEvento"},{"name":"hostId","type":"number"},{"name":"nomeHost"},{"name":"nomeEvento"},{"name":"clock","type":"number"},{"name":"dataHoraQuedaFormatada"},{"name":"nomeHostLimpo"},{"name":"segundosVariavelCliente","type":"number"},{"name":"statusChamado"},{"name":"idClientetPlanilha","type":"number"},{"name":"relacaoClienteMax"},{"name":"idMovideskTickets","type":"number"},{"name":"destinatarioMovidesk"},{"name":"ccMovidesk"}]}},"id":"c055762a-8fe7-4141-a639-df2372f30060","typeVersion":1.1,"name":"Main","type":"n8n-nodes-base.executeWorkflowTrigger","position":[128,64]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"cc1def41-b486-40e0-a4c2-5862b24ac381","leftValue":"={{ $json.statusChamado }}","rightValue":"Abertura Chamado","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[576,64],"id":"d4cb7294-3fe8-4f3e-aff6-a133d1b44d4d","name":"Abertura chamado?"},{"parameters":{"assignments":{"assignments":[{"id":"85ae8ed7-12c2-48da-8a0a-52a205fb5848","name":"idEvento","value":"={{ $json.idEvento }}","type":"number"},{"id":"69427fce-cee5-4557-ac53-ed4a959d1397","name":"hostId","value":"={{ $json.hostId }}","type":"number"},{"id":"3ef4dd92-d549-430c-afad-a0e64539a369","name":"nomeHost","value":"={{ $json.nomeHost }}","type":"string"},{"id":"64de0cd4-da96-4a1c-ac48-9608aaa30536","name":"nomeEvento","value":"={{ $json.nomeEvento }}","type":"string"},{"id":"19d6464e-74bd-449c-b7c4-6d0a4c09627a","name":"clock","value":"={{ $json.clock }}","type":"number"},{"id":"f921bb38-a7b2-4ab1-a153-b32b6e656a6a","name":"dataHoraQuedaFormatada","value":"={{ $json.dataHoraQuedaFormatada }}","type":"string"},{"id":"4db93430-04f6-42dc-9dff-1626b1e0e822","name":"nomeHostLimpo","value":"={{ $json.nomeHostLimpo }}","type":"string"},{"id":"1573df28-c2ca-4582-a33d-5bfe25edc90f","name":"segundosVariavelCliente","value":"={{ $json.segundosVariavelCliente }}","type":"number"},{"id":"82e7552f-d602-4da8-925c-45802f2b964c","name":"statusChamado","value":"={{ $json.statusChamado }}","type":"string"},{"id":"5dc0759b-efe7-48b6-9df1-315733e4e91f","name":"idClientetPlanilha","value":"={{ $json.idClientetPlanilha }}","type":"number"},{"id":"660a7b1d-f372-4439-87b2-36a87f3fd0db","name":"relacaoClienteMax","value":"={{ $json.relacaoClienteMax }}","type":"string"},{"id":"765c6827-e140-448e-b3a6-ab65235a822d","name":"idMovideskTickets","value":"={{ $json.idMovideskTickets }}","type":"string"},{"id":"86c0cc80-aa5b-4a11-82c3-75adb4d6e4b8","name":"destinatarioMovidesk","value":"={{ $json.destinatarioMovidesk }}","type":"string"},{"id":"0b26f6ce-86f1-4996-90c9-394bdb1221e7","name":"ccMovidesk","value":"={{ $json.ccMovidesk }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[352,64],"id":"c2b90d36-ec6c-4bbc-95a2-e34b6d30ce1e","name":"Prepara os dados1"}],"connections":{"Subtrai tempo vari√°vel cliente do tempo atual":{"main":[[{"node":"Recupera as linhas correspondentes","type":"main","index":0}]]},"Valida se existe ticket e direciona":{"main":[[{"node":"Rotas","type":"main","index":0}]]},"Separa alertas com acks === 6":{"main":[[{"node":"Se vazio, ent√£o abrir chamado","type":"main","index":0}]]},"Consulta por eventos anteriores":{"main":[[{"node":"Separa alertas com acks === 6","type":"main","index":0}]]},"Se vazio, ent√£o abrir chamado":{"main":[[{"node":"Recupera dados do cliente na planilha","type":"main","index":0}],[{"node":"Prepara dados para ack","type":"main","index":0}]]},"Prepara dados para ack":{"main":[[{"node":"Valida se existe ticket Movidesk","type":"main","index":0}]]},"Prepara para update mensagem correta1":{"main":[[{"node":"Atualiza evento Zabbix","type":"main","index":0},{"node":"Atualiza a equipe sobre o alerta sem ticket","type":"main","index":0}]]},"Adiciona nova linha na tabela":{"main":[[{"node":"Prepara para update mensagem correta1","type":"main","index":0}]]},"Adiciona nova linha na tabela1":{"main":[[{"node":"Prepara para update mensagem correta","type":"main","index":0}]]},"Prepara para update mensagem correta":{"main":[[{"node":"Atualiza evento Zabbix","type":"main","index":0},{"node":"Atualiza a equipe sobre o alerta com ticket","type":"main","index":0}]]},"Valida se existe ticket Movidesk":{"main":[[{"node":"Adiciona nova linha na tabela","type":"main","index":0}],[{"node":"Adiciona nova linha na tabela1","type":"main","index":0}]]},"Atualiza evento Zabbix":{"main":[[]]},"Prepara dados para abertura de chamado no Movidesk":{"main":[[{"node":"Movidesk: Informa cliente da indisponibilidade","type":"main","index":0}]]},"Cria linha de chamado aberto":{"main":[[{"node":"Prepara para update mensagem correta2","type":"main","index":0}]]},"Prepara para update mensagem correta2":{"main":[[{"node":"Atualiza evento Zabbix1","type":"main","index":0}]]},"Recupera dados do cliente na planilha":{"main":[[{"node":"Prepara dados para abertura de chamado no Movidesk","type":"main","index":0}]]},"Recupera as linhas correspondentes":{"main":[[{"node":"Valida se existe ticket e direciona","type":"main","index":0}]]},"Rotas":{"main":[[{"node":"Confirma igualdade de host","type":"main","index":0}],[{"node":"Consulta por eventos anteriores","type":"main","index":0}]]},"Recupera dados da tabela":{"main":[[{"node":"Tem dados na tabela?","type":"main","index":0}]]},"Tem dados na tabela?":{"main":[[{"node":"Prepara dados para abertura de chamado no Movidesk1","type":"main","index":0}],[{"node":"Fa√ßa nada","type":"main","index":0}]]},"Prepara dados para abertura de chamado no Movidesk1":{"main":[[{"node":"Movidesk: Informa cliente da indisponibilidade1","type":"main","index":0}]]},"Prepara para update mensagem correta3":{"main":[[{"node":"Atualiza evento Zabbix2","type":"main","index":0}]]},"Atualiza qnd_quedas no per√≠odo":{"main":[[{"node":"Prepara para update mensagem correta3","type":"main","index":0}]]},"Prepara para update mensagem correta4":{"main":[[{"node":"Atualiza evento Zabbix3","type":"main","index":0}]]},"Atualiza linha do event matriz":{"main":[[{"node":"Prepara para update mensagem correta4","type":"main","index":0}]]},"Movidesk: Informa cliente da indisponibilidade":{"main":[[{"node":"Cria linha de chamado aberto","type":"main","index":0}]]},"Confirma igualdade de host":{"main":[[{"node":"Atualiza qnd_quedas no per√≠odo","type":"main","index":0}],[{"node":"Prepara push para evento relacionados","type":"main","index":0}]]},"Prepara push para evento relacionados":{"main":[[{"node":"Atualiza linha do event matriz","type":"main","index":0}]]},"Main":{"main":[[{"node":"Prepara os dados1","type":"main","index":0}]]},"Prepara os dados1":{"main":[[{"node":"Abertura chamado?","type":"main","index":0}]]},"Abertura chamado?":{"main":[[{"node":"Subtrai tempo vari√°vel cliente do tempo atual","type":"main","index":0}],[{"node":"Recupera dados da tabela","type":"main","index":0}]]}},"authors":"system migration","name":null,"description":null,"autosaved":false},"tags":[{"updatedAt":"2025-10-24T18:08:27.659Z","createdAt":"2025-10-24T18:08:27.659Z","id":"oUDNU2rUDi9xwp5Q","name":"FluxoNOC_principal"},{"updatedAt":"2025-11-04T16:51:26.805Z","createdAt":"2025-10-28T19:52:51.873Z","id":"y2aOpy57Bluz7ons","name":"clientes_gerais"}]}